!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t(require("lodash")):"function"==typeof define&&define.amd?define(["lodash"],t):"object"==typeof exports?exports.Rete=t(require("lodash")):e.Rete=t(e._)}(this,function(e){return function(e){function t(i){if(n[i])return n[i].exports;var r=n[i]={i:i,l:!1,exports:{}};return e[i].call(r.exports,r,r.exports,t),r.l=!0,r.exports}var n={};return t.m=e,t.c=n,t.i=function(e){return e},t.d=function(e,n,i){t.o(e,n)||Object.defineProperty(e,n,{configurable:!1,enumerable:!0,get:i})},t.n=function(e){var n=e&&e.__esModule?function(){return e.default}:function(){return e};return t.d(n,"a",n),n},t.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},t.p="",t(t.s=14)}([function(e,t,n){"use strict";function i(e){return e&&e.__esModule?e:{default:e}}function r(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function o(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}function a(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0}),t.ProposedAction=t.ActionNode=t.NCCPartnerNode=t.NCCNode=t.NegativeNode=t.NegativeJoinResult=t.JoinNode=t.BetaMemory=t.ReteNode=t.AlphaNode=t.AlphaMemoryItem=t.AlphaMemory=t.Token=t.WME=void 0;var s=function(){function e(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,n,i){return n&&e(t.prototype,n),i&&e(t,i),t}}(),u=n(1),c=i(u),l=0,d=function(){function e(t,n,i,r,o,s,u,c,d){a(this,e),this.id=l++,this.actionStringIdentifier=i,this.type="ProposedAction",this.reteNet=t,this.actionType=n,this.payload=r,this.token=o,this.timing={proposeTime:s||0,invalidateTime:s+(u?u.invalidateOffset:0),performOffset:u?u.performOffset:0,unperformOffset:u?u.unperformOffset:0},this.priority=c||0,this.tags=d||{},this.parallelActions=new Set,this.token&&this.token.proposedActions&&this.token.proposedActions.push(this)}return s(e,[{key:"addParallelAction",value:function(e){e!==this.id&&this.parallelActions.indexOf(e)===-1&&this.parallelActions.add(e)}},{key:"getParallelActions",value:function(){return Array.from(this.parallelActions)}},{key:"removeFromParentToken",value:function(){var e=this;void 0!==this.token&&null!==this.token&&(this.token.proposedActions=c.default.reject(this.token.proposedActions,function(t){return t.id===e.id}))}}]),e}(),f=function e(t,n){a(this,e),this.id=l++,this.type="WME",this.data=t,void 0===n&&(n=0),this.lifeTime=[n],this.alphaMemoryItems=[],this.tokens=[],this.negJoinResults=[]},h=function e(t,n,i,r){a(this,e),this.id=l++,this.type="Token",this.parentToken=t,this.wme=n,this.owningNode=i,this.children=[],this.negJoinResults=[],this.nccResults=[],this.proposedActions=[],this.parentToken&&this.parentToken.children.unshift(this),this.wme&&this.wme.tokens&&this.wme.tokens.unshift(this),this.bindings={},this.parentToken&&this.parentToken.bindings&&c.default.keys(this.parentToken.bindings).forEach(function(e){this.bindings[e]=this.parentToken.bindings[e]},this),c.default.keys(r).forEach(function(e){this.bindings[e]=r[e]},this)},p=function e(t,n){a(this,e),this.id=l++,this.type="AlphaMemoryItem",this.wme=t,this.alphaMemory=n},m=function e(t,n){a(this,e),this.id=l++,this.type="AlphaNode",this.parent=t,this.parent&&this.parent.children&&this.parent.children.unshift(this),this.children=[],this.outputMemory=void 0,n?(this.testField=n.field,this.testValue=n.value,this.operator=n.operator):this.passThrough=!0},y=function e(t){if(a(this,e),this.id=l++,this.type="AlphaMemory",this.items=[],this.parent=t,this.parent&&!(this.parent instanceof m))throw new Error("Adding alpha memory as child of not a test");if(!(this.parent&&this.parent instanceof m&&void 0===this.parent.outputMemory))throw new Error("trying to create an alpha memory for a node that already has one");this.parent.outputMemory=this,this.children=[],this.unlinkedChildren=[],this.referenceCount=0},v=function e(t){a(this,e),this.id=l++,this.type="ReteNode",this.children=[],this.unlinkedChildren=[],this.parent=t,this.parent&&this.parent.children&&this.parent.children.unshift(this)},g=function(e){function t(e){a(this,t);var n=r(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e));return n.type="BetaMemory",n.items=[],void 0===e&&(n.dummy=!0,n.items.push(new h),n.items[0].owningNode=n),n}return o(t,e),t}(v),N=function(e){function t(e,n,i){a(this,t);var o=r(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e));return o.type="JoinNode",o.alphaMemory=n,o.tests=i?i:[],o.alphaMemory&&o.alphaMemory.children&&(o.alphaMemory.children.unshift(o),o.alphaMemory.referenceCount+=1),o.nearestAncestor=null,o.items=[],o}return o(t,e),t}(v),w=function(e){function t(e,n,i,o,s){a(this,t);var u=r(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e));return u.type="ActionNode",u.name=o,u.actionDescriptions=n,u.boundActions=i,u.reteNet=s,u}return o(t,e),t}(v),A=function e(t,n){a(this,e),this.id=l++,this.type="Negative Join Result",this.owner=t,this.owner&&this.owner.negJoinResults.unshift(this),this.wme=n,this.wme&&this.wme.negJoinResults.unshift(this)},M=function(e){function t(e,n,i){a(this,t);var o=r(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e));return o.type="Negative Node",o.items=[],o.alphaMemory=n,o.alphaMemory&&(o.alphaMemory.referenceCount++,o.alphaMemory.children.unshift(o)),o.tests=i||[],o.nearestAncestor=null,o}return o(t,e),t}(v),E=function(e){function t(e){a(this,t);var n=r(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));return n.type="NCCNode",n.parent=e,n.parent&&n.parent.children&&n.parent.children.push(n),n.items=[],n.partner=null,n}return o(t,e),t}(v),T=function(e){function t(e,n){a(this,t);var i=r(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e));return i.type="NCCPartnerNode",i.nccNode=null,i.numberOfConjuncts=n,i.newResultBuffer=[],i}return o(t,e),t}(v);t.WME=f,t.Token=h,t.AlphaMemory=y,t.AlphaMemoryItem=p,t.AlphaNode=m,t.ReteNode=v,t.BetaMemory=g,t.JoinNode=N,t.NegativeJoinResult=A,t.NegativeNode=M,t.NCCNode=E,t.NCCPartnerNode=T,t.ActionNode=w,t.ProposedAction=d},function(t,n){t.exports=e},function(e,t,n){"use strict";function i(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t.default=e,t}function r(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(t,"__esModule",{value:!0}),t.applyRegex=t.applyArithmetic=t.createNewWMEData=t.objDescToObject=t.cleanupInvalidatedActions=t.retrieveWMEValueFromDotString=t.findNearestAncestorWithAlphaMemory=t.compareConstantNodeToTest=t.CompareJoinTests=t.relinkToBetaMemory=t.ifEmptyNegNodeUnlink=t.ifEmptyBetaMemoryUnlink=t.relinkToAlphaMemory=t.unlinkAlphaMemory=void 0;var o="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},a=n(1),s=r(a),u=n(0),c=i(u),l=n(5),d=r(l),f=function(e){if(!(e instanceof c.JoinNode||e instanceof c.NegativeNode))throw new Error("trying to relink alpha on something other than a join node or negative node");for(var t=e.nearestAncestor,n=e.alphaMemory.children.map(function(e){return e.id});t&&n.indexOf(t.id)===-1;)t=N(t,e.alphaMemory.id);if(null!==t){var i=e.alphaMemory.children.map(function(e){return e.id}).indexOf(t.id);e.alphaMemory.children.splice(i,0,e)}else e.alphaMemory.children.push(e);var r=e.alphaMemory.unlinkedChildren.map(function(e){return e.id}).indexOf(e.id);e.alphaMemory.unlinkedChildren.splice(r,1)},h=function(e){if(0!==e.parent.unlinkedChildren.length){var t=e.parent.unlinkedChildren.map(function(e){return e.id}).indexOf(e.id);t>-1&&(e.parent.unlinkedChildren.splice(t,1),e.parent.children.unshift(e))}},p=function(e){0===e.items.length&&e.children.forEach(function(e){if(e instanceof c.JoinNode){var t=e.parent.children.map(function(e){return e.id}).indexOf(e.id),n=e.parent.children.splice(t,1);e.parent.unlinkedChildren.push(n[0])}})},m=function(e){return!(!e||!(e instanceof c.BetaMemory||e instanceof c.JoinNode))&&(0===e.items.length&&e.children.forEach(function(e){if(e instanceof c.JoinNode){var t=e.alphaMemory.children.map(function(e){return e.id}).indexOf(e.id);if(t!==-1){var n=e.alphaMemory.children.splice(t,1);e.alphaMemory.unlinkedChildren.push(n[0])}}}),!0)},y=function(e){if(e&&e instanceof c.NegativeNode&&0===e.items.length){var t=e.alphaMemory.children.map(function(e){return e.id}).indexOf(e.id),n=e.alphaMemory.children.splice(t,1);e.alphaMemory.unlinkedChildren.push(n[0])}},v=function(e,t){return e.testField===t.field&&e.testValue===t.value&&e.operator===t.operator},g=function(e,t){try{if(e.length!==t.length)throw"unequal lengths";for(var n=0;n<e.length;n++){var i=e[n],r=t[n];if(i[0]!==r[0])throw"different bound names";if(i[1][0]!==r[1][0])throw"different source names";if(i[1][1].length!==r[1][1].length)throw"different binding tests length";for(var o=0;i[1][1].length;o++){if(i[1][1][o][0]!==r[1][1][o][0])throw"different comp operator";if(i[1][1][o][1]!==r[1][1][o][1])throw"different comp value"}}}catch(e){return!1}return!0},N=function e(t,n){return t.dummy?null:(t instanceof c.JoinNode||t instanceof c.NegativeNode)&&t.alphaMemory.id===n.id?t:t instanceof c.NCCNode?e(t.partner.parent,n):e(t.parent,n)},w=function(e,t){for(var n=t.split("."),i=e.data;n.length>0;){var r=n.shift();if(void 0===i[r])return null;i=i[r]}return i},A=function(e){if(0!==e.length&&void 0!==e[0].reteNet){var t=e[0].reteNet,n=e.map(function(e){return e.id});s.default.forEach(n,function(e){return t.unproposeAction(e)})}},M=function(e,t){var n=t||{};return s.default.keys(e).reduce(function(t,n){for(var i=n.split(/\./),r=t,a=void 0;i.length>1;)a=i.shift(),void 0!==r[a]&&"object"===o(r[a])||(r[a]={}),r=r[a];return a=i.shift(),r[a]=e[n],t},n)},E=function(e,t){var n=s.default.reduce(s.default.keys(e.values),function(n,i){var r=e.values[i];return n[i]=b(r,t.bindings),n},{bindings:{}});return s.default.reduce(s.default.keys(t.bindings),function(e,n){return e.bindings[n]=t.bindings[n],e},n)},T=function(e,t){s.default.keys(e.arithmeticActions).forEach(function(n){var i=e.arithmeticActions[n],r=Number(t[n]),o=d.default[i[0]],a="number"==typeof i[1]?i[1]:i[1].match(/\$/)?parseInt(t.bindings[i[1].slice(1)],10):parseInt(i[1],10);if(void 0===o)throw new Error("Undefined arithmetic function");if(isNaN(r)||isNaN(a))throw new Error("Arithmetic value should be convertable to a number: "+r+" "+a);t[n]=o(r,a)})},k=function(e,t){s.default.keys(e.regexActions).forEach(function(n){var i=e.regexActions[n],r=new RegExp(i[0],i[1]),o=b(i[2],t.bindings);t[n]=t[n].replace(r,o)})},b=function(e,t){for(var n=/\${(\w+)}/g.exec(e);null!==n;){if(void 0===t[n[1]])throw new Error("Unrecognised binding: "+n[1]);e=C(e,n.index,t[n[1]],n[0].length),n=/\${(\w+)}/g.exec(e)}return e},C=function(e,t,n,i){return e.slice(0,t)+n+e.slice(t+i)};t.unlinkAlphaMemory=p,t.relinkToAlphaMemory=f,t.ifEmptyBetaMemoryUnlink=m,t.ifEmptyNegNodeUnlink=y,t.relinkToBetaMemory=h,t.CompareJoinTests=g,t.compareConstantNodeToTest=v,t.findNearestAncestorWithAlphaMemory=N,t.retrieveWMEValueFromDotString=w,t.cleanupInvalidatedActions=A,t.objDescToObject=M,t.createNewWMEData=E,t.applyArithmetic=T,t.applyRegex=k},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i={EQ:function(e,t){return e===t},LT:function(e,t){return e<t},GT:function(e,t){return e>t},LTE:function(e,t){return e<=t},GTE:function(e,t){return e>=t},NE:function(e,t){return e!==t},MATCH:function(e,t){return new RegExp(t).test(e)}};i["==="]=i.EQ,i["<"]=i.LT,i[">"]=i.GT,i["<="]=i.LTE,i[">="]=i.GTE,i["!=="]=i.NE,i["~="]=i.MATCH,t.default=i},function(e,t,n){"use strict";function i(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t.default=e,t}function r(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(t,"__esModule",{value:!0}),t.activateIfNegatedJRIsUnblocked=t.alphaNodeActivation=t.rightActivate=t.leftActivate=t.deleteNodeAndAnyUnusedAncestors=t.deleteAllNegJoinResultsForWME=t.deleteAllTokensForWME=t.removeAlphaMemoryItemsForWME=t.deleteDescendentsOfToken=void 0;var o=n(1),a=r(o),s=n(0),u=i(s),c=n(3),l=r(c),d=n(2),f=i(d),h=n(13),p=r(h),m=function(e,t){var n=new u.AlphaMemoryItem(t,e);e.items.unshift(n),t.alphaMemoryItems.unshift(n),a.default.clone(e.children).forEach(function(e){return E(e,t)})},y=function(e,t){var n=!1;if(e.passThrough)n=!0;else{var i=f.retrieveWMEValueFromDotString(t,e.testField),r=e.testValue,o=e.operator;if(null===i)return!1;l.default[o]&&(n="EQ"!==o&&"NE"!==o?l.default[o](Number(i),Number(r)):l.default[o](i,r))}return n&&(e.outputMemory&&v(e.outputMemory,t),e.children.forEach(function(e){return v(e,t)})),n},v=function(e,t){if(!(e instanceof u.AlphaMemory)){if(e instanceof u.AlphaNode)return y(e,t);throw new Error("Unrecognised node:",e)}m(e,t)},g=function(e,t){var n=t;e.items.unshift(n),a.default.clone(e.children).forEach(function(e){return M(e,n)})},N=function(e,t){if(e.parent.items&&1===e.parent.items.length&&(f.relinkToAlphaMemory(e),0===e.alphaMemory.items.length)){var n=e.parent.children.map(function(e){return e.id}).indexOf(e.id),i=e.parent.children.splice(n,1);e.parent.unlinkedChildren.push(i[0])}e.alphaMemory.items.forEach(function(n){var i=n.wme,r=(0,p.default)(e,t,i);if(void 0!==r&&r!==!1){var o=new u.Token(t,i,e,r);e.items.unshift(o),e.children.forEach(function(e){return M(e,o)})}})},w=function(e,t){if(1===e.alphaMemory.items.length&&(f.relinkToBetaMemory(e),0===e.parent.items.length)){var n=e.alphaMemory.children.map(function(e){return e.id}).indexOf(e.id),i=e.alphaMemory.children.splice(n,1);e.alphaMemory.unlinkedChildren.push(i[0])}e.parent.items.forEach(function(n){if(n.negJoinResults.length>0||n.nccResults.length>0)return!1;var i=(0,p.default)(e,n,t);if(void 0!==i&&i!==!1){var r=new u.Token(n,t,e,i);e.items.unshift(r);a.default.clone(e.children).forEach(function(e){return M(e,r)})}})},A=function(e,t){var n=e.boundActions,i=n.map(function(n){return n(t,e.reteNet)}),r=i.map(function(e){return e.id});i.forEach(function(t){r.forEach(function(e){t.addParallelAction(e)}),e.reteNet.proposeAction(t)})},M=function(e,t,n,i){if(e instanceof u.JoinNode||e instanceof u.ActionNode||(t=new u.Token(t,n,e,i)),e.__isDummy);else if(e instanceof u.BetaMemory)g(e,t);else if(e instanceof u.JoinNode)N(e,t);else if(e instanceof u.NegativeNode)T(e,t);else if(e instanceof u.NCCNode)b(e,t);else if(e instanceof u.NCCPartnerNode)C(e,t);else{if(!(e instanceof u.ActionNode))throw new Error("Unknown node type leftActivated");A(e,t)}return t},E=function(e,t){if(e instanceof u.JoinNode)w(e,t);else{if(!(e instanceof u.NegativeNode))throw new Error("Tried to rightActivate Unrecognised node");k(e,t)}},T=function(e,t){if(0===e.items.length&&f.relinkToAlphaMemory(e),e.items.unshift(t),e.alphaMemory.items.forEach(function(n){var i=n.wme;(0,p.default)(e,t,i)&&new u.NegativeJoinResult(t,i)}),0===t.negJoinResults.length){a.default.clone(e.children).forEach(function(e){return M(e,t)})}},k=function(e,t){e.items.forEach(function(n){if(n.negJoinResults.length>0||n.nccResults.length>0)return!1;var i=(0,p.default)(e,n,t);if(void 0!==i&&i!==!1){if(0===n.negJoinResults.length){var r=B(n);f.cleanupInvalidatedActions(r)}new u.NegativeJoinResult(n,t)}})},b=function(e,t){if(!(e instanceof u.NCCNode))throw new Error("nccNodeLeftActivation should be on an NCCNode");if(!(t instanceof u.Token))throw new Error("nccNodeLeftActivation should be on a token");var n=t;for(e.items.unshift(n);e.partner&&e.partner.newResultBuffer.length>0;){var i=e.partner.newResultBuffer.pop();n.nccResults.unshift(i),i.parentToken=n}if(0===n.nccResults.length){a.default.clone(e.children).forEach(function(e){return M(e,n)})}},C=function(e,t){for(var n=e.nccNode,i=t,r=t.parentToken,o=t.wme,s=void 0,u=0;u<e.numberOfConjuncts;u++)o=r.wme,r=r.parentToken;if(void 0!==n&&r&&o){var c=a.default.reject(n.items,function(e){return e.parentToken.id!==r.id||e.wme&&e.wme.id!==o.id});c.length>0&&(s=c[0])}if(void 0!==s){s.nccResults.unshift(i),i.parentToken=s;var l=B(s);f.cleanupInvalidatedActions(l)}else e.newResultBuffer.unshift(i)},O=function(e){var t=e;if(0===t.owner.negJoinResults.length){a.default.clone(t.owner.owningNode.children).forEach(function(e){return M(e,t.owner)})}},R=function(e){e.alphaMemoryItems.forEach(function(e){e.alphaMemory.items=a.default.reject(e.alphaMemory.items,function(t){return t.id===e.id}),f.unlinkAlphaMemory(e.alphaMemory),e.alphaMemory=void 0,e.wme=void 0}),e.alphaMemoryItems=[]},_=function(e){for(var t=new Set;e.tokens.length>0;)F(e.tokens[0]).forEach(function(e){return t.add(e)});return Array.from(t)},j=function(e){e.negJoinResults.forEach(function(e){e.owner.negJoinResults=a.default.reject(e.owner.negJoinResults,function(t){return t.id===e.id}),O(e),e.owner=void 0,e.wme=void 0}),e.negJoinResults=[]},P=function(e){e.negJoinResults.forEach(function(e){e.wme.negJoinResults=a.default.reject(e.wme.negJoinResults,function(t){return t.id===e.id}),e.wme=void 0,e.token=void 0}),e.negJoinResults=[]},J=function(e){!e.owningNode||e.owningNode instanceof u.NCCPartnerNode||(e.owningNode.items=a.default.reject(e.owningNode.items,function(t){return t.id===e.id}))},W=function(e){e.wme&&e.wme.tokens&&(e.wme.tokens=a.default.reject(e.wme.tokens,function(t){return t.id===e.id}))},x=function(e){e&&e.parentToken&&(e.parentToken.children=a.default.reject(e.parentToken.children,function(t){return t.id===e.id}))},I=function e(t){var n=new Set;if(t instanceof u.ActionNode&&(t.reteNet=null),t instanceof u.NCCNode){var i=t.partner;t.partner=null,e(i).forEach(function(e){return n.add(e)})}if(t instanceof u.BetaMemory&&void 0===t.dummy||t instanceof u.NegativeNode||t instanceof u.NCCNode||t instanceof u.JoinNode)for(;t.items.length>0;){var r=t.items.pop();F(r).forEach(function(e){return n.add(e)})}if(t instanceof u.NCCPartnerNode)for(;t.newResultBuffer.length>0;){var o=t.newResultBuffer.pop();F(o).forEach(function(e){return n.add(e)})}if(t.alphaMemory&&(t instanceof u.JoinNode||t instanceof u.NegativeNode)&&(t.alphaMemory.children=a.default.reject(t.alphaMemory.children,function(e){return e.id===t.id}),t.alphaMemory.unlinkedChildren=a.default.reject(t.alphaMemory.unlinkedChildren,function(e){return e.id===t.id}),t.alphaMemory.referenceCount--,t.alphaMemory.referenceCount<1)){var s=t.alphaMemory;t.alphaMemory=null,L(s).forEach(function(e){return n.add(e)})}if(t.parent&&(t.parent.children=a.default.reject(t.parent.children,function(e){return e.id===t.id}),t.parent.unlinkedChildren=a.default.reject(t.parent.unlinkedChildren,function(e){return e.id===t.id})),t.parent&&0===t.parent.children.length&&t.parent.unlinkedChildren&&0===t.parent.unlinkedChildren.length&&void 0===t.parent.dummy){var c=t.parent;t.parent=null,e(c).forEach(function(e){return n.add(e)})}return t.children.forEach(function(t){return e(t).forEach(function(e){return n.add(e)})}),t.unlinkedChildren.forEach(function(t){return e(t).forEach(function(e){return n.add(e)})}),t.cleanup=!0,Array.from(n)},B=function(e){for(var t=new Set;e.children.length>0;){F(e.children.pop()).forEach(function(e){return t.add(e)})}return e.proposedActions.forEach(function(e){return t.add(e)}),Array.from(t)},F=function e(t){for(var n=new Set;t.children.length>0;){e(t.children.pop()).forEach(function(e){return n.add(e)})}if(J(t),W(t),x(t),f.ifEmptyBetaMemoryUnlink(t.owningNode),f.ifEmptyNegNodeUnlink(t.owningNode,t.id),P(t),S(t),U(t),t&&t.owningNode&&t.owningNode instanceof u.NCCPartnerNode&&0===t.parentToken.nccResults.length){a.default.clone(t.owningNode.nccNode.children).forEach(function(e){return M(e,t.parentToken)})}return t.proposedActions.forEach(function(e){return n.add(e)}),Array.from(n)},S=function(e){e.nccResults.forEach(function(e){e.wme&&(e.wme.tokens=a.default.reject(e.wme.tokens,function(t){return t.id===e.id})),e.parentToken&&(e.parentToken.children=a.default.reject(e.parentToken.children,function(t){return t.id===e.id}))}),e.nccResults=[]},U=function(e){return!!(e.owningNode&&e.owningNode instanceof u.NCCPartnerNode&&e.parentToken)&&(e.parentToken.nccResults=a.default.reject(e.parentToken.nccResults,function(t){return t.id===e.id}),e.owningNode.newResultBuffer=a.default.reject(e.owningNode.newResultBuffer,function(t){return t.id===e.id}),!0)},L=function e(t){var n=new Set;if(t instanceof u.AlphaNode&&0===t.children.length&&null===t.outputMemory&&void 0===t.passThrough){t.testField=null,t.testValue=null,t.operator=null,t.parent.children=a.default.reject(t.parent.children,function(e){return e.id===t.id});var i=t.parent;t.parent=null,e(i).forEach(function(e){return n.add(e)}),t.cleanup=!0}else if(t instanceof u.AlphaMemory){t.children.forEach(function(e){return I(e)}),t.unlinkedChildren.forEach(function(e){return I(e)}),t.children=[],t.unlinkedChildren=[];var r=t.items.map(function(e){return e.id}),o=t.items.map(function(e){return e.wme});o.forEach(function(e){e.alphaMemoryItems=a.default.reject(e.alphaMemoryItems,function(e){return r.indexOf(e.id)>-1})}),t.items=[];var s=t.parent;s.outputMemory=null,t.parent=null,e(s).forEach(function(e){return n.add(e)}),t.cleanup=!0}return Array.from(n)};t.deleteDescendentsOfToken=B,t.removeAlphaMemoryItemsForWME=R,t.deleteAllTokensForWME=_,t.deleteAllNegJoinResultsForWME=j,t.deleteNodeAndAnyUnusedAncestors=I,t.leftActivate=M,t.rightActivate=E,t.alphaNodeActivation=v,t.activateIfNegatedJRIsUnblocked=O},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=function(e,t){return e+t},r=function(e,t){return e-t},o=function(e,t){return e*t},a=function(e,t){return e/t},s={"+":i,"-":r,"*":o,"/":a};t.default=s},function(e,t,n){"use strict";function i(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(t,"__esModule",{value:!0});var r=n(9),o=i(r),a=n(10),s=i(a),u=n(11),c=i(u),l=n(12),d=i(l),f={};t.default=f,f[o.default.name]=o.default,f[s.default.name]=s.default,f[c.default.name]=c.default,f[d.default.name]=d.default},function(e,t,n){"use strict";function i(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t.default=e,t}function r(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(t,"__esModule",{value:!0});var o=n(1),a=r(o),s=n(0),u=i(s),c=n(2),l=i(c),d=n(4),f=i(d),h=function e(t,n,i,r,o){var s=t,u=void 0;return n.forEach(function(t){if("rule"!==t.tags.type&&"condition"!==t.tags.type)throw new Error("trying to add something that isnt a condition");if("condition"===t.tags.type&&void 0===t.tags.conditionType)throw new Error("Trying to add a condition without a conditionType");var n=a.default.toPairs(t.bindings);if("positive"===t.tags.conditionType)u=m(t,i,r,o),s=v(s,u,n,o);else if("negative"===t.tags.conditionType)u=m(t,i,r,o),s=g(s,u,n,o);else if("negConjCondition"===t.tags.conditionType)s=N(s,t,i,r,o);else{if("rule"!==t.tags.type)throw console.error("Problematic Condition:",t),new Error("Unrecognised condition type");var c=a.default.toPairs(t.linkedNodes).filter(function(e){return/^condition/.test(e[1])}).map(function(e){return r[e[0]]});s=e(s,c,i,r,o)}}),y(s,o)},p=function(e,t,n){for(var i=a.default.values(e.children),r=0;r<i.length;r++){var o=i[r];if(l.compareConstantNodeToTest(o,t))return o}var s=new u.AlphaNode(e,t);return n.storeNode(s),s},m=function(e,t,n,i){var r=t;if(r=e.constantTests.reduce(function(e,t){return p(e,t,i)},r),void 0!==r.outputMemory)return r.outputMemory;var o=new u.AlphaMemory(r);return i.storeNode(o),o},y=function(e,t){if(e instanceof u.BetaMemory||e instanceof u.NCCPartnerNode||e instanceof u.NegativeNode||e instanceof u.NCCNode||e instanceof u.JoinNode)return e;for(var n=a.default.values(e.children),i=0;i<n.length;i++){var r=n[i];if(r instanceof u.BetaMemory)return r}var o=new u.BetaMemory(e);return w(o),t.storeNode(o),o},v=function(e,t,n,i){n instanceof Array||(n=a.default.toPairs(n));for(var r=e.children.concat(e.unlinkedChildren),o=0;o<r.length;o++){var s=r[o];if(s instanceof u.JoinNode&&s.alphaMemory&&s.alphaMemory.id===t.id&&l.compareJoinTests(s.tests,n))return s}var c=new u.JoinNode(e,t,n);if(c.nearestAncestor=l.findNearestAncestorWithAlphaMemory(e,t),0===e.items.length){var d=t.children.map(function(e){return e.id}).indexOf(c.id),f=t.children.splice(d,1);t.unlinkedChildren.unshift(f[0])}else if(0===t.items.length){var h=e.children.map(function(e){return e.id}).indexOf(c.id),p=e.children.splice(h,1);e.unlinkedChildren.unshift(p[0])}return i.storeNode(c),c},g=function(e,t,n,i){n instanceof Array||(n=a.default.toPairs(n));for(var r=a.default.values(e.children),o=0;o<r.length;o++){var s=r[o];if(s instanceof u.NegativeNode&&s.alphaMemory&&s.alphaMemory.id===t.id&&l.compareJoinTests(s.tests,n))return s}var c=new u.NegativeNode(e,t,n);if(c.nearestAncestor=l.findNearestAncestorWithAlphaMemory(e,t),w(c),0===c.items.length){var d=t.children.map(function(e){return e.id}).indexOf(c.id),f=t.children.splice(d,1);t.unlinkedChildren.push(f[0])}return i.storeNode(c),c},N=function(e,t,n,i,r){if("negConjCondition"!==t.tags.conditionType)throw new Error("BuildOrShareNCCNodes only takes NCCCondition");for(var o=a.default.toPairs(t.linkedNodes).filter(function(e){return/condition/.test(e[1])}),s=o.map(function(e){return i[e[0]]}),c=h(e,s,n,i,r),l=0;l<e.children.length;l++){var d=e.children[l];if(d instanceof u.NCCNode&&d.partner.parent&&d.partner.parent.id===c.id)return d}var f=new u.NCCNode(e),p=new u.NCCPartnerNode(c,o.length);return f.partner=p,p.nccNode=f,w(f),w(p),r.storeNode(f),r.storeNode(p),f},w=function(e){var t=e.parent;if(t instanceof u.BetaMemory)for(var n=0;n<t.items.length;n++)f.leftActivate(e,t.items[n]);else if(t instanceof u.JoinNode){var i=t.children,r=a.default.values(t.alphaMemory.items);t.children=[e];for(var o=0;o<r.length;o++){var s=r[o];f.rightActivate(t,s.wme)}t.children=i}else if(t instanceof u.NegativeNode)for(var c=a.default.values(t.items),l=0;l<c.length;l++){var d=c[l];0===d.negJoinResults.length&&f.leftActivate(e,d)}else if(t instanceof u.NCCNode)for(var h=a.default.values(t.items),p=0;p<h.length;p++){var m=t.items[p];0===m.nccResults.length&&f.leftActivate(e,m)}};t.default=h},function(e,t,n){"use strict";function i(e){if(Array.isArray(e)){for(var t=0,n=Array(e.length);t<e.length;t++)n[t]=e[t];return n}return Array.from(e)}function r(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var o=0,a=function e(t){r(this,e),this.id=o++,this.name=t||"anon",this.tags={type:"rule"},this.conditions={},this.actions={}};a.prototype.newCondition=function(e,t){var n=new s(e);return void 0!==t.tests&&t.tests.forEach(function(e){return n.addTest.apply(n,i(e))}),void 0!==t.bindings&&t.bindings.forEach(function(e){return n.addBinding.apply(n,i(e))}),this.addCondition(n),this},a.prototype.newAction=function(e,t,n){var r=new u(e,t);return void 0!==n.values&&n.values.forEach(function(e){return r.addValue.apply(r,i(e))}),void 0!==n.arith&&n.arith.forEach(function(e){return r.addArithmetic.apply(r,i(e))}),void 0!==n.regexs&&n.regexs.forEach(function(e){return r.addRegex.apply(r,i(e))}),void 0!==n.priority&&(r.priority=n.priority),void 0!==n.timing&&r.addTiming.apply(r,i(n.timing)),this.addAction(r),this},a.prototype.addCondition=function(e){return this.conditions[e.id]=e,this},a.prototype.addAction=function(e){return this.actions[e.id]=e,this};var s=function e(t){switch(r(this,e),this.id=o++,this.name="conditon",t=void 0===t?"positive":t){case"positive":this.tags={type:"condition",conditionType:"positive"};break;case"negative":this.tags={type:"condition",conditionType:"negative"};break;case"ncc":this.tags={type:"condition",conditionType:"negConjCondition"};break;default:throw new Error("Unrecognised condition")}this.constantTests=[],this.bindings={},this.conditions={}};s.prototype.addTest=function(e,t,n){return this.constantTests.push({field:e,operator:t,value:n}),this},s.prototype.addBinding=function(e,t,n){this.bindings[e]=[t,n]},s.prototype.newCondition=function(e,t){if("negConjCondition"!==this.type)throw new Error("Only NCC's can have sub conditions");var n=new s(e);t.tests.forEach(function(e){return n.addTest.apply(n,i(e))}),t.bindings.forEach(function(e){return n.addBinding.apply(n,i(e))}),this.conditions[n.id]=n};var u=function e(t,n){r(this,e),this.id=o++,this.name=n||"anon",this.tags={actionType:t||"assert"},this.values={},this.arithmeticActions={},this.regexActions={},this.timing={invalidateOffset:0,performOffset:0,unperformOffset:0},this.priority=0};u.prototype.addValue=function(e,t){return this.values[e]=t,this},u.prototype.addArithmetic=function(e,t,n){return this.arithmeticActions[e]=[t,n],this},u.prototype.addRegex=function(e,t,n,i){return this.regexActions[e]=[t,n,i],this},u.prototype.addTiming=function(e,t,n){return this.timing={invalidateOffset:e,performOffset:t,unperformOffset:n},this},t.Rule=a,t.Condition=s,t.Action=u},function(e,t,n){"use strict";function i(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t.default=e,t}Object.defineProperty(t,"__esModule",{value:!0});var r=n(0),o=i(r),a={name:"assert",propose:null,perform:null};t.default=a,a.propose=function(e,t){var n=t.utils.createNewWMEData(this,e);t.utils.applyArithmetic(this,n),t.utils.applyRegex(this,n);var i=t.utils.objDescToObject(n);return new t.ProposedAction(t,"assert",this.name,i,e,t.currentTime,this.timing,this.priority)},a.perform=function(e,t){if("assert"!==e.actionType)throw new Error("Expected Assert");var n=t.assertWME(e.payload,e.retractTime);return e.timing.unperformOffset>0&&t.addToSchedule(new o.ProposedAction(t,"retract",n,null,t.currentTime,{invalidateOffset:null,performOffset:e.timing.unperformOffset,unperformOffset:null})),{asserted:n}}},function(e,t,n){"use strict";function i(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t.default=e,t}function r(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(t,"__esModule",{value:!0});var o=n(1),a=r(o),s=n(0),u=i(s),c={name:"retract",propose:null,perform:null};t.default=c,c.propose=function(e,t){for(var n=this,i=[],r=e,o=/^\${(\w+)}/;r&&void 0!==r.wme;)i.push(r.wme),r=r.parentToken;var s=a.default.keys(this.values).filter(function(e){return/^wme([0-9]*)/.test(e)}),c=s.map(function(e){return n.values[e]}).filter(function(e){return o.test(e)}),l=c.map(function(t){var n=o.exec(t);return e.bindings[n[1]]});return new u.ProposedAction(t,"retract",this.name,l,e,t.currentTime,this.timing)},c.perform=function(e,t){if("retract"!==e.actionType)throw new Error("Expected retract");if(e.payload instanceof Array){return{retracted:e.payload.map(function(e){return t.retractWME(e)})}}return{retracted:[t.retractWME(e.payload)]}}},function(e,t,n){"use strict";function i(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t.default=e,t}Object.defineProperty(t,"__esModule",{value:!0});var r=n(0),o=i(r),a={name:"addRule",propose:null,perform:null};t.default=a,a.propose=function(e,t){return new o.ProposedAction(t,"NO-OP",this.name,e.wme,e,t.currentTime,this.timing)},a.perform=function(e,t){console.log("No-op")}},function(e,t,n){"use strict";function i(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t.default=e,t}Object.defineProperty(t,"__esModule",{value:!0});var r=n(0),o=i(r),a={name:"removeRule",propose:null,perform:null};t.default=a,a.propose=function(e,t){return new o.ProposedAction(t,"NO-OP",this.name,e.wme,e,t.currentTime,this.timing)},a.perform=function(e,t){console.log("No-op")}},function(e,t,n){"use strict";function i(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t.default=e,t}function r(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(t,"__esModule",{value:!0});var o=n(1),a=r(o),s=n(2),u=i(s),c=n(3),l=r(c),d=function(e,t,n){var i={},r=!0,o=new RegExp(/^\${(\w+)}/);a.default.keys(t.bindings).forEach(function(e){i[e]=t.bindings[e]});try{if(e.tests.forEach(function(e){var t=null;if(t=/^[#\$]id$/.test(e[1][0])?n.id:u.retrieveWMEValueFromDotString(n,e[1][0]),e[1][1].forEach(function(e){var n=l.default[e[0]],r=e[1],a=o.exec(r);if(null===a)throw new Error("No bound let name");if(!n(t,i[a[1]]))throw new Error("Test failed")}),void 0===i[e[0]]&&(i[e[0]]=t),i[e[0]]!==t)throw new Error("Test failed")}),r)return i;throw new Error("Test failed")}catch(e){return!1}};t.default=d},function(e,t,n){"use strict";function i(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t.default=e,t}function r(e){return e&&e.__esModule?e:{default:e}}function o(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var a=n(1),s=r(a),u=n(0),c=i(u),l=n(7),d=r(l),f=n(4),h=i(f),p=n(2),m=i(p),y=n(8),v=n(6),g=r(v),N=n(3),w=r(N),A=n(5),M=r(A),E=function e(t){o(this,e),void 0===t&&(t=[]),this.dummyBetaMemory=new c.BetaMemory,this.rootAlpha=new c.AlphaNode,this.actionFunctions=s.default.clone(g.default),this.Rule=y.Rule,this.ComparisonOperators=w.default,this.ArithmeticOperators=M.default,this.ProposedAction=c.ProposedAction,this.WME=c.WME,this.Token=c.Token,this.utils=m,this.allRules={},this.actions={},this.allWMEs={},this.proposedActions={},this.enactedActions=[],this.allReteNodes={},this.allReteNodesByType={},this.currentTime=1,this.schedule={assert:[],retract:[],modify:[]},this.listeners={propose:[],assert:[],retract:[],addRule:[],removeRule:[],schedule:[],stepTimeActions:[],registerAction:[]},t.forEach(function(e){this.registerAction(e)},this)};E.prototype.registerListener=function(e,t){void 0!==this.listeners[e]&&this.listeners[e].push(t)},E.prototype.fireListener=function(e){for(var t=arguments.length,n=Array(t>1?t-1:0),i=1;i<t;i++)n[i-1]=arguments[i];if(void 0===this.listeners[e])throw new Error("Unrecognised listener fired: "+e);this.listeners[e].forEach(function(e){return e.apply(void 0,n)})},E.prototype.storeWME=function(e){this.allWMEs[e.id]=e},E.prototype.clearHistory=function(){this.enactedActions=[]},E.prototype.clearProposedActions=function(){this.proposedActions={}},E.prototype.assertWME=function(e){return this.fireListener("assert",e),e instanceof c.WME||(e=new c.WME(e,this.currentTime),this.storeWME(e)),h.alphaNodeActivation(this.rootAlpha,e),e.id},E.prototype.retractWME=function(e){if(this.fireListener("retract",e),!(e instanceof c.WME))if(Number.isInteger(e)&&void 0!==this.allWMEs[e])e=this.allWMEs[e];else{if(void 0===e.wmeId||void 0===this.allWMEs[e.wmeId])throw console.log("Unknown:",e),new Error("Unknown wme to retract");e=this.allWMEs[e.wmeId]}h.removeAlphaMemoryItemsForWME(e);var t=h.deleteAllTokensForWME(e);return m.cleanupInvalidatedActions(t),h.deleteAllNegJoinResultsForWME(e),e.lifeTime[1]=this.currentTime,delete this.allWMEs[e.id],e},E.prototype.modifyWME=function(e,t){var n=this.retractWME(e),i=n.data,r=t(i);if(void 0===r||null===r)throw new Error("Modify function must return the new data");return this.assertWME(r)},E.prototype.proposeAction=function(e){var t=this;if(this.fireListener("propose",e),e instanceof Array)return void e.forEach(function(e){return t.proposeAction(e)});if(void 0!==this.proposedActions[e.id])throw new Error("Proposing a duplicate action");this.proposedActions[e.id]=e},E.prototype.unproposeAction=function(e){void 0!==this.proposedActions[e]&&(this.proposedActions[e].removeFromParentToken(),delete this.proposedActions[e])},E.prototype.scheduleAction=function(e){var t=this;if(this.fireListener("schedule",e),e instanceof this.ProposedAction)return void this.scheduleAction(e.id);if(void 0===this.proposedActions[e])throw new Error("Invalid action specified: "+e);var n=this.proposedActions[e],i=n.getParallelActions().map(function(e){return t.proposedActions[e]});return this.addToSchedule(n),i.forEach(function(e){return t.addToSchedule(e)}),this},E.prototype.addToSchedule=function(e){if(void 0===e.actionType||void 0===e.payload||void 0===e.timing)throw new Error("Scheduling action failure");void 0===this.schedule[e.actionType]&&(this.schedule[e.actionType]=[]);var t=this.currentTime+e.timing.performOffset;void 0===this.schedule[e.actionType][t]&&(this.schedule[e.actionType][t]=[]),this.schedule[e.actionType][t].push(e),this.unproposeAction(e.id)},E.prototype.stepTime=function(){var e=this,t=s.default.values(this.schedule),n=s.default.reject(s.default.flatten(t.map(function(t){return t[e.currentTime]})),function(e){return void 0===e});n.sort(function(e,t){return t.priority-e.priority}),this.fireListener("stepTimeActions",n);var i=n.map(function(e){var t=this.actionFunctions[e.actionType].perform,n=t(e,this);return this.enactedActions.push(e),n},this);return s.default.values(this.proposedActions).forEach(function(e){e.timing.invalidateTime<=this.currentTime&&this.unproposeAction(e.id)},this),this.currentTime++,i},E.prototype.addRule=function(e,t){var n=this;if(this.fireListener("addRule",t),e instanceof Array)return e.map(function(e){return n.addRule(e,t)});if(e instanceof this.Rule){var i=this.convertRulesToComponents(e);return this.addRule(e.id,i)}if(!Number.isInteger(e)||void 0===t[e])throw new Error("Unrecognised rule id specified");var r=t[e],o=s.default.toPairs(r.linkedNodes),a=o.filter(function(e){return/^condition/.test(e[1])}).map(function(e){return t[e[0]]}),u=(0,d.default)(this.dummyBetaMemory,a,this.rootAlpha,t,this),l=o.filter(function(e){return/^action/.test(e[1])}).map(function(e){return t[e[0]]}),f=l.map(function(e){if(void 0===this.actionFunctions[e.tags.actionType])throw new Error("Unrecognised action type");return s.default.bind(this.actionFunctions[e.tags.actionType].propose,e)},this),h=new c.ActionNode(u,l,f,r.name,this);return h.ruleId=r.id,h.boundActions=f,this.actions[h.ruleId]=h,this.allRules[h.ruleId]=r,[this,h]},E.prototype.removeRule=function(e){var t=this;if(this.fireListener("removeRule",e),e instanceof Array)return void e.forEach(function(e){return t.removeRule(e)});var n=e instanceof c.ActionNode?e:this.actions[e.id],i=h.deleteNodeAndAnyUnusedAncestors(n);m.cleanupInvalidatedActions(i),void 0!==this.allRules[n.ruleId]&&delete this.allRules[n.ruleId],s.default.keys(this.allReteNodes).forEach(function(e){if(this.allReteNodes[e].cleanup===!0){var t=this.allReteNodes[e];delete this.allReteNodesByType[t.type][t.id],delete this.allReteNodes[e]}},this),void 0!==this.actions[e.id]&&delete this.actions[e.id]},E.prototype.registerAction=function(e){if(this.fireListener("registerAction",e),void 0===e.name||void 0===e.perform||void 0===e.propose)throw new Error("Action Registration Failure");if(void 0!==this.actionFunctions[e.name])throw new Error("Registration Attempt for existing Action");this.actionFunctions[e.name]=e},E.prototype.storeNode=function(e){this.allReteNodes[e.id]=e,void 0===this.allReteNodesByType[e.type]&&(this.allReteNodesByType[e.type]={}),this.allReteNodesByType[e.type][e.id]=e},E.prototype.convertRulesToComponents=function(e){e instanceof Array||(e=[e]);var t=s.default.flatten(e.map(function(e){return s.default.values(e.actions)})),n=s.default.flatten(e.map(function(e){return s.default.values(e.conditions)})),i=t.concat(n).concat(e),r=i.reduce(function(e,t){return e[t.id]=t,e},{});return s.default.values(r).forEach(function(e){e.linkedNodes={},e.linkedNodes=s.default.keys(e.actions).reduce(function(e,t){return e[t]="action",e},e.linkedNodes),e.linkedNodes=s.default.keys(e.conditions).reduce(function(e,t){return e[t]="condition",e},e.linkedNodes)}),r},E.prototype.cleanup=function(){var e=this;s.default.values(this.allWMEs).forEach(function(t){return e.retractWME(t)}),this.allWMEs={},this.removeRule(s.default.values(this.allRules))},t.default=E}])});