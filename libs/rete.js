!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t(require("lodash")):"function"==typeof define&&define.amd?define(["lodash"],t):"object"==typeof exports?exports.Rete=t(require("lodash")):e.Rete=t(e._)}(this,function(e){return function(e){function t(i){if(n[i])return n[i].exports;var r=n[i]={i:i,l:!1,exports:{}};return e[i].call(r.exports,r,r.exports,t),r.l=!0,r.exports}var n={};return t.m=e,t.c=n,t.i=function(e){return e},t.d=function(e,n,i){t.o(e,n)||Object.defineProperty(e,n,{configurable:!1,enumerable:!0,get:i})},t.n=function(e){var n=e&&e.__esModule?function(){return e.default}:function(){return e};return t.d(n,"a",n),n},t.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},t.p="",t(t.s=14)}([function(t,n){t.exports=e},function(e,t,n){"use strict";function i(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(t,"__esModule",{value:!0}),t.ProposedAction=t.ActionNode=t.NCCPartnerNode=t.NCCNode=t.NegativeNode=t.NegativeJoinResult=t.JoinNode=t.BetaMemory=t.ReteNode=t.AlphaNode=t.AlphaMemoryItem=t.AlphaMemory=t.Token=t.WME=void 0;var r=n(0),o=i(r),a=0,s=function(e,t,n,i,r,o,s,u){this.id=a++,this.type="ProposedAction",this.reteNet=e,this.actionType=t,this.payload=n,this.token=i,this.timing={proposeTime:r,invalidateTime:r+(o?o.invalidateOffset:0),performOffset:o?o.performOffset:0,unperformOffset:o?o.unperformOffset:0},this.priority=s||0,this.tags=u||{},this.token&&this.token.proposedActions&&this.token.proposedActions.push(this)},u=function(e,t){this.id=a++,this.type="WME",this.data=e,void 0===t&&(t=0),this.lifeTime=[t],this.alphaMemoryItems=[],this.tokens=[],this.negJoinResults=[]},c=function(e,t,n,i){this.id=a++,this.type="Token",this.parentToken=e,this.wme=t,this.owningNode=n,this.children=[],this.negJoinResults=[],this.nccResults=[],this.proposedActions=[],this.parentToken&&this.parentToken.children.unshift(this),this.wme&&this.wme.tokens&&this.wme.tokens.unshift(this),this.bindings={},this.parentToken&&this.parentToken.bindings&&o.default.keys(this.parentToken.bindings).forEach(function(e){this.bindings[e]=this.parentToken.bindings[e]},this),o.default.keys(i).forEach(function(e){this.bindings[e]=i[e]},this)},d=function(e,t){this.id=a++,this.type="AlphaMemoryItem",this.wme=e,this.alphaMemory=t},l=function(e,t){this.id=a++,this.type="AlphaNode",this.parent=e,this.parent&&this.parent.children&&this.parent.children.unshift(this),this.children=[],this.outputMemory=void 0,t?(this.testField=t.field,this.testValue=t.value,this.operator=t.operator):this.passThrough=!0},f=function(e){if(this.id=a++,this.type="AlphaMemory",this.items=[],this.parent=e,this.parent&&!(this.parent instanceof l))throw new Error("Adding alpha memory as child of not a test");if(!(this.parent&&this.parent instanceof l&&void 0===this.parent.outputMemory))throw new Error("trying to create an alpha memory for a node that already has one");this.parent.outputMemory=this,this.children=[],this.unlinkedChildren=[],this.referenceCount=0},h=function(e){this.id=a++,this.type="ReteNode",this.children=[],this.unlinkedChildren=[],this.parent=e,this.parent&&this.parent.children&&this.parent.children.unshift(this)},p=function(e){h.call(this,e),this.type="BetaMemory",this.items=[],void 0===e&&(this.dummy=!0,this.items.push(new c),this.items[0].owningNode=this)},m=function(e,t,n){h.call(this,e),this.type="JoinNode",this.alphaMemory=t,this.tests=n?n:[],this.alphaMemory&&this.alphaMemory.children&&(this.alphaMemory.children.unshift(this),this.alphaMemory.referenceCount+=1),this.nearestAncestor=null,this.items=[]},v=function(e,t,n,i,r){h.call(this,e),this.type="ActionNode",this.name=i,this.actionDescriptions=t,this.boundActions=n,this.reteNet=r},y=function(e,t){this.id=a++,this.type="Negative Join Result",this.owner=e,this.owner&&this.owner.negJoinResults.unshift(this),this.wme=t,this.wme&&this.wme.negJoinResults.unshift(this)},g=function(e,t,n){h.call(this,e),this.type="Negative Node",this.items=[],this.alphaMemory=t,this.alphaMemory&&(this.alphaMemory.referenceCount++,this.alphaMemory.children.unshift(this)),this.tests=n||[],this.nearestAncestor=null},N=function(e){h.call(this),this.type="NCCNode",this.parent=e,this.parent&&this.parent.children&&this.parent.children.push(this),this.items=[],this.partner=null},w=function(e,t){h.call(this,e),this.type="NCCPartnerNode",this.nccNode=null,this.numberOfConjuncts=t,this.newResultBuffer=[],this.id=a};t.WME=u,t.Token=c,t.AlphaMemory=f,t.AlphaMemoryItem=d,t.AlphaNode=l,t.ReteNode=h,t.BetaMemory=p,t.JoinNode=m,t.NegativeJoinResult=y,t.NegativeNode=g,t.NCCNode=N,t.NCCPartnerNode=w,t.ActionNode=v,t.ProposedAction=s},function(e,t,n){"use strict";function i(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t.default=e,t}function r(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(t,"__esModule",{value:!0}),t.applyRegex=t.applyArithmetic=t.createNewWMEData=t.objDescToObject=t.cleanupInvalidatedActions=t.retrieveWMEValueFromDotString=t.findNearestAncestorWithAlphaMemory=t.compareConstantNodeToTest=t.CompareJoinTests=t.relinkToBetaMemory=t.ifEmptyNegNodeUnlink=t.ifEmptyBetaMemoryUnlink=t.relinkToAlphaMemory=t.unlinkAlphaMemory=void 0;var o="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},a=n(0),s=r(a),u=n(1),c=i(u),d=n(3),l=i(d),f=function(e){if(!(e instanceof c.JoinNode||e instanceof c.NegativeNode))throw new Error("trying to relink alpha on something other than a join node or negative node");for(var t=e.nearestAncestor,n=e.alphaMemory.children.map(function(e){return e.id});t&&n.indexOf(t.id)===-1;)t=N(t,e.alphaMemory.id);if(null!==t){var i=e.alphaMemory.children.map(function(e){return e.id}).indexOf(t.id);e.alphaMemory.children.splice(i,0,e)}else e.alphaMemory.children.push(e);var r=e.alphaMemory.unlinkedChildren.map(function(e){return e.id}).indexOf(e.id);e.alphaMemory.unlinkedChildren.splice(r,1)},h=function(e){if(0!==e.parent.unlinkedChildren.length){var t=e.parent.unlinkedChildren.map(function(e){return e.id}).indexOf(e.id);t>-1&&(e.parent.unlinkedChildren.splice(t,1),e.parent.children.unshift(e))}},p=function(e){0===e.items.length&&e.children.forEach(function(e){if(e instanceof c.JoinNode){var t=e.parent.children.map(function(e){return e.id}).indexOf(e.id),n=e.parent.children.splice(t,1);e.parent.unlinkedChildren.push(n[0])}})},m=function(e){return!(!e||!(e instanceof c.BetaMemory||e instanceof c.JoinNode))&&(0===e.items.length&&e.children.forEach(function(e){if(e instanceof c.JoinNode){var t=e.alphaMemory.children.map(function(e){return e.id}).indexOf(e.id);if(t!==-1){var n=e.alphaMemory.children.splice(t,1);e.alphaMemory.unlinkedChildren.push(n[0])}}}),!0)},v=function(e){if(e&&e instanceof c.NegativeNode&&0===e.items.length){var t=e.alphaMemory.children.map(function(e){return e.id}).indexOf(e.id),n=e.alphaMemory.children.splice(t,1);e.alphaMemory.unlinkedChildren.push(n[0])}},y=function(e,t){return e.testField===t.field&&e.testValue===t.value&&e.operator===t.operator},g=function(e,t){try{if(e.length!==t.length)throw"unequal lengths";for(var n=0;n<e.length;n++){var i=e[n],r=t[n];if(i[0]!==r[0])throw"different bound names";if(i[1][0]!==r[1][0])throw"different source names";if(i[1][1].length!==r[1][1].length)throw"different binding tests length";for(var o=0;i[1][1].length;o++){if(i[1][1][o][0]!==r[1][1][o][0])throw"different comp operator";if(i[1][1][o][1]!==r[1][1][o][1])throw"different comp value"}}}catch(e){return!1}return!0},N=function e(t,n){return t.dummy?null:(t instanceof c.JoinNode||t instanceof c.NegativeNode)&&t.alphaMemory.id===n.id?t:t instanceof c.NCCNode?e(t.partner.parent,n):e(t.parent,n)},w=function(e,t){for(var n=t.split("."),i=e.data;n.length>0;){var r=n.shift();if(void 0===i[r])return null;i=i[r]}return i},A=function(e){if(0!==e.length&&void 0!==e[0].reteNet){var t=e[0].reteNet,n=e.map(function(e){return e.id});t.proposedActions=s.default.reject(t.proposedActions,function(e){return void 0===e||n.indexOf(e.id)!==-1})}},M=function(e,t){var n=t||{};return s.default.keys(e).reduce(function(t,n){for(var i=n.split(/\./),r=t,a=void 0;i.length>1;)a=i.shift(),void 0!==r[a]&&"object"===o(r[a])||(r[a]={}),r=r[a];return a=i.shift(),r[a]=e[n],t},n)},E=function(e,t){var n=s.default.reduce(s.default.keys(e.values),function(n,i){var r=e.values[i];return n[i]=C(r,t.bindings),n},{bindings:{}});return s.default.reduce(s.default.keys(t.bindings),function(e,n){return e.bindings[n]=t.bindings[n],e},n)},T=function(e,t){s.default.keys(e.arithmeticActions).forEach(function(n){var i=e.arithmeticActions[n],r=Number(t[n]),o=l[i[0]],a="number"==typeof i[1]?i[1]:i[1].match(/\$/)?parseInt(t.bindings[i[1].slice(1)],10):parseInt(i[1],10);if(void 0===o)throw new Error("Undefined arithmetic function");if(isNaN(r)||isNaN(a))throw new Error("Arithmetic value should be convertable to a number: "+r+" "+a);t[n]=o(r,a)})},k=function(e,t){s.default.keys(e.regexActions).forEach(function(n){var i=e.regexActions[n],r=new RegExp(i[0],i[1]),o=C(i[2],t.bindings);t[n]=t[n].replace(r,o)})},C=function(e,t){for(var n=/\${(\w+)}/g.exec(e);null!==n;){if(void 0===t[n[1]])throw new Error("Unrecognised binding: "+n[1]);e=R(e,n.index,t[n[1]],n[0].length),n=/\${(\w+)}/g.exec(e)}return e},R=function(e,t,n,i){return e.slice(0,t)+n+e.slice(t+i)};t.unlinkAlphaMemory=p,t.relinkToAlphaMemory=f,t.ifEmptyBetaMemoryUnlink=m,t.ifEmptyNegNodeUnlink=v,t.relinkToBetaMemory=h,t.CompareJoinTests=g,t.compareConstantNodeToTest=y,t.findNearestAncestorWithAlphaMemory=N,t.retrieveWMEValueFromDotString=w,t.cleanupInvalidatedActions=A,t.objDescToObject=M,t.createNewWMEData=E,t.applyArithmetic=T,t.applyRegex=k},function(e,t,n){"use strict";function i(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(t,"__esModule",{value:!0}),t.moduleInterface=void 0;var r=n(0),o=(i(r),function(e,t){return e+t}),a=function(e,t){return e-t},s=function(e,t){return e*t},u=function(e,t){return e/t},c={"+":o,"-":a,"*":s,"/":u};t.moduleInterface=c},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i={EQ:function(e,t){return e===t},LT:function(e,t){return e<t},GT:function(e,t){return e>t},LTE:function(e,t){return e<=t},GTE:function(e,t){return e>=t},NE:function(e,t){return e!==t},MATCH:function(e,t){return new RegExp(t).test(e)}};i["==="]=i.EQ,i["<"]=i.LT,i[">"]=i.GT,i["<="]=i.LTE,i[">="]=i.GTE,i["!=="]=i.NE,i["~="]=i.MATCH,t.ConstantTestOperators=i},function(e,t,n){"use strict";function i(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t.default=e,t}function r(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(t,"__esModule",{value:!0}),t.activateIfNegatedJRIsUnblocked=t.alphaNodeActivation=t.rightActivate=t.leftActivate=t.deleteNodeAndAnyUnusedAncestors=t.deleteAllNegJoinResultsForWME=t.deleteAllTokensForWME=t.removeAlphaMemoryItemsForWME=t.deleteDescendentsOfToken=void 0;var o=n(0),a=r(o),s=n(1),u=i(s),c=n(4),d=i(c),l=n(2),f=i(l),h=n(13),p=i(h),m=function(e,t){var n=new u.AlphaMemoryItem(t,e);e.items.unshift(n),t.alphaMemoryItems.unshift(n),a.default.clone(e.children).forEach(function(e){return E(e,t)})},v=function(e,t){var n=!1;if(e.passThrough)n=!0;else{var i=f.retrieveWMEValueFromDotString(t,e.testField),r=e.testValue,o=e.operator;if(null===i)return!1;d[o]&&(n="EQ"!==o&&"NE"!==o?d[o](Number(i),Number(r)):d[o](i,r))}return n&&(e.outputMemory&&y(e.outputMemory,t),e.children.forEach(function(e){return y(e,t)})),n},y=function(e,t){if(!(e instanceof u.AlphaMemory)){if(e instanceof u.AlphaNode)return v(e,t);throw new Error("Unrecognised node:",e)}m(e,t)},g=function(e,t){var n=t;e.items.unshift(n),a.default.clone(e.children).forEach(function(e){return M(e,n)})},N=function(e,t){if(e.parent.items&&1===e.parent.items.length&&(f.relinkToAlphaMemory(e),0===e.alphaMemory.items.length)){var n=e.parent.children.map(function(e){return e.id}).indexOf(e.id),i=e.parent.children.splice(n,1);e.parent.unlinkedChildren.push(i[0])}e.alphaMemory.items.forEach(function(n){var i=n.wme,r=p.performJoinTests(e,t,i);if(void 0!==r&&r!==!1){var o=new u.Token(t,i,e,r);e.items.unshift(o),e.children.forEach(function(e){return M(e,o)})}})},w=function(e,t){if(1===e.alphaMemory.items.length&&(f.relinkToBetaMemory(e),0===e.parent.items.length)){var n=e.alphaMemory.children.map(function(e){return e.id}).indexOf(e.id),i=e.alphaMemory.children.splice(n,1);e.alphaMemory.unlinkedChildren.push(i[0])}e.parent.items.forEach(function(n){if(n.negJoinResults.length>0||n.nccResults.length>0)return!1;var i=p.performJoinTests(e,n,t);if(void 0!==i&&i!==!1){var r=new u.Token(n,t,e,i);e.items.unshift(r);a.default.clone(e.children).forEach(function(e){return M(e,r)})}})},A=function(e,t){var n=e.boundActions,i=n.map(function(n){return n(t,e.reteNet)}),r=i.map(function(e){return e.id});i.forEach(function(t){t.parallelActions=a.default.reject(r,function(e){return e===t.id}),e.reteNet.proposeAction(t)})},M=function(e,t,n,i){if(e instanceof u.JoinNode||e instanceof u.ActionNode||(t=new u.Token(t,n,e,i)),e.__isDummy);else if(e instanceof u.BetaMemory)g(e,t);else if(e instanceof u.JoinNode)N(e,t);else if(e instanceof u.NegativeNode)T(e,t);else if(e instanceof u.NCCNode)C(e,t);else if(e instanceof u.NCCPartnerNode)R(e,t);else{if(!(e instanceof u.ActionNode))throw new Error("Unknown node type leftActivated");A(e,t)}return t},E=function(e,t){if(e instanceof u.JoinNode)w(e,t);else{if(!(e instanceof u.NegativeNode))throw new Error("Tried to rightActivate Unrecognised node");k(e,t)}},T=function(e,t){if(0===e.items.length&&f.relinkToAlphaMemory(e),e.items.unshift(t),e.alphaMemory.items.forEach(function(n){var i=n.wme;p.performJoinTests(e,t,i)&&new u.NegativeJoinResult(t,i)}),0===t.negJoinResults.length){a.default.clone(e.children).forEach(function(e){return M(e,t)})}},k=function(e,t){console.log("Negative node right activation"),e.items.forEach(function(n){if(n.negJoinResults.length>0||n.nccResults.length>0)return!1;var i=p.performJoinTests(e,n,t);if(void 0!==i&&i!==!1){if(0===n.negJoinResults.length){var r=B(n);f.cleanupInvalidatedActions(r)}new u.NegativeJoinResult(n,t)}})},C=function(e,t){if(!(e instanceof u.NCCNode))throw new Error("nccNodeLeftActivation should be on an NCCNode");if(!(t instanceof u.Token))throw new Error("nccNodeLeftActivation should be on a token");var n=t;for(e.items.unshift(n);e.partner&&e.partner.newResultBuffer.length>0;){var i=e.partner.newResultBuffer.pop();n.nccResults.unshift(i),i.parentToken=n}if(0===n.nccResults.length){a.default.clone(e.children).forEach(function(e){return M(e,n)})}},R=function(e,t){for(var n=e.nccNode,i=t,r=t.parentToken,o=t.wme,s=void 0,u=0;u<e.numberOfConjuncts;u++)o=r.wme,r=r.parentToken;if(void 0!==n&&r&&o){var c=a.default.reject(n.items,function(e){return e.parentToken.id!==r.id||e.wme&&e.wme.id!==o.id});c.length>0&&(s=c[0])}if(void 0!==s){s.nccResults.unshift(i),i.parentToken=s;var d=B(s);f.cleanupInvalidatedActions(d)}else e.newResultBuffer.unshift(i)},b=function(e){var t=e;if(0===t.owner.negJoinResults.length){a.default.clone(t.owner.owningNode.children).forEach(function(e){return M(e,t.owner)})}},O=function(e){e.alphaMemoryItems.forEach(function(e){e.alphaMemory.items=a.default.reject(e.alphaMemory.items,function(t){return t.id===e.id}),f.unlinkAlphaMemory(e.alphaMemory),e.alphaMemory=void 0,e.wme=void 0}),e.alphaMemoryItems=[]},_=function(e){for(var t=new Set;e.tokens.length>0;)F(e.tokens[0]).forEach(function(e){return t.add(e)});return Array.from(t)},j=function(e){e.negJoinResults.forEach(function(e){e.owner.negJoinResults=a.default.reject(e.owner.negJoinResults,function(t){return t.id===e.id}),b(e),e.owner=void 0,e.wme=void 0}),e.negJoinResults=[]},P=function(e){e.negJoinResults.forEach(function(e){e.wme.negJoinResults=a.default.reject(e.wme.negJoinResults,function(t){return t.id===e.id}),e.wme=void 0,e.token=void 0}),e.negJoinResults=[]},J=function(e){!e.owningNode||e.owningNode instanceof u.NCCPartnerNode||(e.owningNode.items=a.default.reject(e.owningNode.items,function(t){return t.id===e.id}))},W=function(e){e.wme&&e.wme.tokens&&(e.wme.tokens=a.default.reject(e.wme.tokens,function(t){return t.id===e.id}))},x=function(e){e&&e.parentToken&&(e.parentToken.children=a.default.reject(e.parentToken.children,function(t){return t.id===e.id}))},I=function e(t){var n=new Set;if(t instanceof u.ActionNode&&(t.reteNet=null),t instanceof u.NCCNode){var i=t.partner;t.partner=null,e(i).forEach(function(e){return n.add(e)})}if(t instanceof u.BetaMemory&&void 0===t.dummy||t instanceof u.NegativeNode||t instanceof u.NCCNode||t instanceof u.JoinNode)for(;t.items.length>0;){var r=t.items.pop();F(r).forEach(function(e){return n.add(e)})}if(t instanceof u.NCCPartnerNode)for(;t.newResultBuffer.length>0;){var o=t.newResultBuffer.pop();F(o).forEach(function(e){return n.add(e)})}if(t.alphaMemory&&(t instanceof u.JoinNode||t instanceof u.NegativeNode)&&(t.alphaMemory.children=a.default.reject(t.alphaMemory.children,function(e){return e.id===t.id}),t.alphaMemory.unlinkedChildren=a.default.reject(t.alphaMemory.unlinkedChildren,function(e){return e.id===t.id}),t.alphaMemory.referenceCount--,t.alphaMemory.referenceCount<1)){var s=t.alphaMemory;t.alphaMemory=null,L(s).forEach(function(e){return n.add(e)})}if(t.parent&&(t.parent.children=a.default.reject(t.parent.children,function(e){return e.id===t.id}),t.parent.unlinkedChildren=a.default.reject(t.parent.unlinkedChildren,function(e){return e.id===t.id})),t.parent&&0===t.parent.children.length&&t.parent.unlinkedChildren&&0===t.parent.unlinkedChildren.length&&void 0===t.parent.dummy){var c=t.parent;t.parent=null,e(c).forEach(function(e){return n.add(e)})}return t.children.forEach(function(t){return e(t).forEach(function(e){return n.add(e)})}),t.unlinkedChildren.forEach(function(t){return e(t).forEach(function(e){return n.add(e)})}),t.cleanup=!0,Array.from(n)},B=function(e){for(var t=new Set;e.children.length>0;){F(e.children.pop()).forEach(function(e){return t.add(e)})}return e.proposedActions.forEach(function(e){return t.add(e)}),Array.from(t)},F=function e(t){for(var n=new Set;t.children.length>0;){e(t.children.pop()).forEach(function(e){return n.add(e)})}if(J(t),W(t),x(t),f.ifEmptyBetaMemoryUnlink(t.owningNode),f.ifEmptyNegNodeUnlink(t.owningNode,t.id),P(t),S(t),U(t),t&&t.owningNode&&t.owningNode instanceof u.NCCPartnerNode&&0===t.parentToken.nccResults.length){a.default.clone(t.owningNode.nccNode.children).forEach(function(e){return M(e,t.parentToken)})}return t.proposedActions.forEach(function(e){return n.add(e)}),Array.from(n)},S=function(e){e.nccResults.forEach(function(e){e.wme&&(e.wme.tokens=a.default.reject(e.wme.tokens,function(t){return t.id===e.id})),e.parentToken&&(e.parentToken.children=a.default.reject(e.parentToken.children,function(t){return t.id===e.id}))}),e.nccResults=[]},U=function(e){return!!(e.owningNode&&e.owningNode instanceof u.NCCPartnerNode&&e.parentToken)&&(e.parentToken.nccResults=a.default.reject(e.parentToken.nccResults,function(t){return t.id===e.id}),e.owningNode.newResultBuffer=a.default.reject(e.owningNode.newResultBuffer,function(t){return t.id===e.id}),!0)},L=function e(t){var n=new Set;if(t instanceof u.AlphaNode&&0===t.children.length&&null===t.outputMemory&&void 0===t.passThrough){t.testField=null,t.testValue=null,t.operator=null,t.parent.children=a.default.reject(t.parent.children,function(e){return e.id===t.id});var i=t.parent;t.parent=null,e(i).forEach(function(e){return n.add(e)}),t.cleanup=!0}else if(t instanceof u.AlphaMemory){t.children.forEach(function(e){return I(e)}),t.unlinkedChildren.forEach(function(e){return I(e)}),t.children=[],t.unlinkedChildren=[];var r=t.items.map(function(e){return e.id}),o=t.items.map(function(e){return e.wme});o.forEach(function(e){e.alphaMemoryItems=a.default.reject(e.alphaMemoryItems,function(e){return r.indexOf(e.id)>-1})}),t.items=[];var s=t.parent;s.outputMemory=null,t.parent=null,e(s).forEach(function(e){return n.add(e)}),t.cleanup=!0}return Array.from(n)};t.deleteDescendentsOfToken=B,t.removeAlphaMemoryItemsForWME=O,t.deleteAllTokensForWME=_,t.deleteAllNegJoinResultsForWME=j,t.deleteNodeAndAnyUnusedAncestors=I,t.leftActivate=M,t.rightActivate=E,t.alphaNodeActivation=y,t.activateIfNegatedJRIsUnblocked=b},function(e,t,n){"use strict";function i(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t.default=e,t}function r(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(t,"__esModule",{value:!0}),t.ActionInterface=void 0;var o=n(0),a=(r(o),n(3)),s=(i(a),n(2)),u=(i(s),n(1)),c=(i(u),n(9)),d=i(c),l=n(10),f=i(l),h=n(11),p=i(h),m=n(12),v=i(m),y={};y[d.name]=d,y[f.name]=f,y[p.name]=p,y[v.name]=v,t.ActionInterface=y},function(e,t,n){"use strict";function i(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t.default=e,t}function r(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(t,"__esModule",{value:!0}),t.buildOrShareNetworkForConditions=void 0;var o=n(0),a=r(o),s=n(1),u=i(s),c=n(2),d=i(c),l=n(5),f=i(l),h=function e(t,n,i,r,o){var s=t,u=void 0;return n.forEach(function(t){if("rule"!==t.tags.type&&"condition"!==t.tags.type)throw new Error("trying to add something that isnt a condition");if("condition"===t.tags.type&&void 0===t.tags.conditionType)throw new Error("Trying to add a condition without a conditionType");var n=a.default.toPairs(t.bindings);if("positive"===t.tags.conditionType)u=m(t,i,r,o),s=y(s,u,n,o);else if("negative"===t.tags.conditionType)u=m(t,i,r,o),s=g(s,u,n,o);else if("negConjCondition"===t.tags.conditionType)s=N(s,t,i,r,o);else{if("rule"!==t.tags.type)throw console.error("Problematic Condition:",t),new Error("Unrecognised condition type");var c=a.default.toPairs(t.linkedNodes).filter(function(e){return/^condition/.test(e[1])}).map(function(e){return r[e[0]]});s=e(s,c,i,r,o)}}),v(s,o)},p=function(e,t,n){for(var i=a.default.values(e.children),r=0;r<i.length;r++){var o=i[r];if(d.compareConstantNodeToTest(o,t))return o}var s=new u.AlphaNode(e,t);return n.storeNode(s),s},m=function(e,t,n,i){var r=t;if(r=e.constantTests.reduce(function(e,t){return p(e,t,i)},r),void 0!==r.outputMemory)return r.outputMemory;var o=new u.AlphaMemory(r);return i.storeNode(o),o},v=function(e,t){if(e instanceof u.BetaMemory||e instanceof u.NCCPartnerNode||e instanceof u.NegativeNode||e instanceof u.NCCNode||e instanceof u.JoinNode)return e;for(var n=a.default.values(e.children),i=0;i<n.length;i++){var r=n[i];if(r instanceof u.BetaMemory)return r}var o=new u.BetaMemory(e);return w(o),t.storeNode(o),o},y=function(e,t,n,i){n instanceof Array||(n=a.default.toPairs(n));for(var r=e.children.concat(e.unlinkedChildren),o=0;o<r.length;o++){var s=r[o];if(s instanceof u.JoinNode&&s.alphaMemory&&s.alphaMemory.id===t.id&&d.compareJoinTests(s.tests,n))return s}var c=new u.JoinNode(e,t,n);if(c.nearestAncestor=d.findNearestAncestorWithAlphaMemory(e,t),0===e.items.length){var l=t.children.map(function(e){return e.id}).indexOf(c.id),f=t.children.splice(l,1);t.unlinkedChildren.unshift(f[0])}else if(0===t.items.length){var h=e.children.map(function(e){return e.id}).indexOf(c.id),p=e.children.splice(h,1);e.unlinkedChildren.unshift(p[0])}return i.storeNode(c),c},g=function(e,t,n,i){n instanceof Array||(n=a.default.toPairs(n));for(var r=a.default.values(e.children),o=0;o<r.length;o++){var s=r[o];if(s instanceof u.NegativeNode&&s.alphaMemory&&s.alphaMemory.id===t.id&&d.compareJoinTests(s.tests,n))return s}var c=new u.NegativeNode(e,t,n);if(c.nearestAncestor=d.findNearestAncestorWithAlphaMemory(e,t),w(c),0===c.items.length){var l=t.children.map(function(e){return e.id}).indexOf(c.id),f=t.children.splice(l,1);t.unlinkedChildren.push(f[0])}return i.storeNode(c),c},N=function(e,t,n,i,r){if("negConjCondition"!==t.tags.conditionType)throw new Error("BuildOrShareNCCNodes only takes NCCCondition");for(var o=a.default.toPairs(t.linkedNodes).filter(function(e){return/condition/.test(e[1])}),s=o.map(function(e){return i[e[0]]}),c=h(e,s,n,i,r),d=0;d<e.children.length;d++){var l=e.children[d];if(l instanceof u.NCCNode&&l.partner.parent&&l.partner.parent.id===c.id)return l}var f=new u.NCCNode(e),p=new u.NCCPartnerNode(c,o.length);return f.partner=p,p.nccNode=f,w(f),w(p),r.storeNode(f),r.storeNode(p),f},w=function(e){var t=e.parent;if(t instanceof u.BetaMemory)for(var n=0;n<t.items.length;n++)f.leftActivate(e,t.items[n]);else if(t instanceof u.JoinNode){var i=t.children,r=a.default.values(t.alphaMemory.items);t.children=[e];for(var o=0;o<r.length;o++){var s=r[o];f.rightActivate(t,s.wme)}t.children=i}else if(t instanceof u.NegativeNode)for(var c=a.default.values(t.items),d=0;d<c.length;d++){var l=c[d];0===l.negJoinResults.length&&f.leftActivate(e,l)}else if(t instanceof u.NCCNode)for(var h=a.default.values(t.items),p=0;p<h.length;p++){var m=t.items[p];0===m.nccResults.length&&f.leftActivate(e,m)}};t.buildOrShareNetworkForConditions=h},function(e,t,n){"use strict";function i(e){if(Array.isArray(e)){for(var t=0,n=Array(e.length);t<e.length;t++)n[t]=e[t];return n}return Array.from(e)}Object.defineProperty(t,"__esModule",{value:!0});var r=0,o=function(e){this.id=r++,this.name=e||"anon",this.tags={type:"rule"},this.conditions={},this.actions={}};o.prototype.newCondition=function(e,t){var n=new a(e);return void 0!==t.tests&&t.tests.forEach(function(e){return n.addTest.apply(n,i(e))}),void 0!==t.bindings&&t.bindings.forEach(function(e){return n.addBinding.apply(n,i(e))}),this.addCondition(n),this},o.prototype.newAction=function(e,t,n){var r=new s(e,t);return void 0!==n.values&&n.values.forEach(function(e){return r.addValue.apply(r,i(e))}),void 0!==n.arith&&n.arith.forEach(function(e){return r.addArithmetic.apply(r,i(e))}),void 0!==n.regexs&&n.regexs.forEach(function(e){return r.addRegex.apply(r,i(e))}),void 0!==n.priority&&(r.priority=n.priority),void 0!==n.timing&&r.addTiming.apply(r,i(n.timing)),this.addAction(r),this},o.prototype.addCondition=function(e){return this.conditions[e.id]=e,this},o.prototype.addAction=function(e){return this.actions[e.id]=e,this};var a=function(e){switch(this.id=r++,this.name="conditon",e=void 0===e?"positive":e){case"positive":this.tags={type:"condition",conditionType:"positive"};break;case"negative":this.tags={type:"condition",conditionType:"negative"};break;case"ncc":this.tags={type:"condition",conditionType:"negConjCondition"};break;default:throw new Error("Unrecognised condition")}this.constantTests=[],this.bindings={},this.conditions={}};a.prototype.addTest=function(e,t,n){return this.constantTests.push({field:e,operator:t,value:n}),this},a.prototype.addBinding=function(e,t,n){this.bindings[e]=[t,n]},a.prototype.newCondition=function(e,t){if("negConjCondition"!==this.type)throw new Error("Only NCC's can have sub conditions");var n=new a(e);t.tests.forEach(function(e){return n.addTest.apply(n,i(e))}),t.bindings.forEach(function(e){return n.addBinding.apply(n,i(e))}),this.conditions[n.id]=n};var s=function(e,t){this.id=r++,this.name=t||"anon",this.tags={actionType:e||"assert"},this.values={},this.arithmeticActions={},this.regexActions={},this.timing={invalidateOffset:0,performOffset:0,unperformOffset:0},this.priority=0};s.prototype.addValue=function(e,t){return this.values[e]=t,this},s.prototype.addArithmetic=function(e,t,n){return this.arithmeticActions[e]=[t,n],this},s.prototype.addRegex=function(e,t,n,i){return this.regexActions[e]=[t,n,i],this},s.prototype.addTiming=function(e,t,n){return this.timing={invalidateOffset:e,performOffset:t,unperformOffset:n},this},t.Rule=o,t.Condition=a,t.Action=s},function(e,t,n){"use strict";function i(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t.default=e,t}function r(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(t,"__esModule",{value:!0}),t.AssertAction=void 0;var o=n(0),a=(r(o),n(3)),s=(i(a),n(2)),u=(i(s),n(1)),c=i(u),d={name:"assert",propose:null,perform:null};d.propose=function(e,t){var n=t.utils.createNewWMEData(this,e);t.utils.applyArithmetic(this,n),t.utils.applyRegex(this,n);var i=t.utils.objDescToObject(n);return new t.ProposedAction(t,"assert",i,e,t.currentTime,this.timing,this.priority)},d.perform=function(e,t){if("assert"!==e.actionType)throw new Error("Expected Assert");var n=t.assertWME(e.payload,e.retractTime);return e.timing.unperformOffset>0&&t.addToSchedule(new c.ProposedAction(t,"retract",n,null,t.currentTime,{invalidateOffset:null,performOffset:e.timing.unperformOffset,unperformOffset:null})),{asserted:n}},t.AssertAction=d},function(e,t,n){"use strict";function i(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t.default=e,t}function r(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(t,"__esModule",{value:!0}),t.RetractAction=void 0;var o=n(0),a=r(o),s=n(3),u=(i(s),n(2)),c=(i(u),n(1)),d=i(c),l={name:"retract",propose:null,perform:null};l.propose=function(e,t){for(var n=this,i=[],r=e,o=/^\${(\w+)}/;r&&void 0!==r.wme;)i.push(r.wme),r=r.parentToken;var s=a.default.keys(this.values).filter(function(e){return/^wme([0-9]*)/.test(e)}),u=s.map(function(e){return n.values[e]}).filter(function(e){return o.test(e)}),c=u.map(function(t){var n=o.exec(t);return e.bindings[n[1]]});return new d.ProposedAction(t,"retract",c,e,t.currentTime,this.timing)},l.perform=function(e,t){if("retract"!==e.actionType)throw new Error("Expected retract");if(e.payload instanceof Array){return{retracted:e.payload.map(function(e){return t.retractWME(e)})}}return{retracted:[t.retractWME(e.payload)]}},t.RetractAction=l},function(e,t,n){"use strict";function i(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t.default=e,t}function r(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(t,"__esModule",{value:!0}),t.ActionInterface=void 0;var o=n(0),a=(r(o),n(3)),s=(i(a),n(2)),u=(i(s),n(1)),c=i(u),d={name:"addRule",propose:null,perform:null};d.propose=function(e,t){return new c.ProposedAction(t,"NO-OP",e.wme,e,t.currentTime,this.timing)},d.perform=function(e,t){console.log("No-op")},t.ActionInterface=d},function(e,t,n){"use strict";function i(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t.default=e,t}function r(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(t,"__esModule",{value:!0}),t.ActionInterface=void 0;var o=n(0),a=(r(o),n(3)),s=(i(a),n(2)),u=(i(s),n(1)),c=i(u),d={name:"removeRule",propose:null,perform:null};d.propose=function(e,t){return new c.ProposedAction(t,"NO-OP",e.wme,e,t.currentTime,this.timing)},d.perform=function(e,t){console.log("No-op")},t.ActionInterface=d},function(e,t,n){"use strict";function i(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t.default=e,t}function r(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(t,"__esModule",{value:!0}),t.performJoinTests=void 0;var o=n(0),a=r(o),s=n(1),u=(i(s),n(2)),c=i(u),d=n(4),l=i(d),f=function(e,t,n){var i={},r=!0,o=new RegExp(/^\${(\w+)}/);a.default.keys(t.bindings).forEach(function(e){i[e]=t.bindings[e]});try{if(e.tests.forEach(function(e){var t=null;if(t=/^[#\$]id$/.test(e[1][0])?n.id:c.retrieveWMEValueFromDotString(n,e[1][0]),e[1][1].forEach(function(e){var n=l[e[0]],r=e[1],a=o.exec(r);if(null===a)throw new Error("No bound let name");if(!n(t,i[a[1]]))throw new Error("Test failed")}),void 0===i[e[0]]&&(i[e[0]]=t),i[e[0]]!==t)throw new Error("Test failed")}),r)return i;throw new Error("Test failed")}catch(e){return!1}};t.performJoinTests=f},function(e,t,n){"use strict";function i(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t.default=e,t}function r(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(t,"__esModule",{value:!0}),t.ReteNet=void 0;var o=n(0),a=r(o),s=n(1),u=i(s),c=n(7),d=i(c),l=n(5),f=i(l),h=n(2),p=i(h),m=n(8),v=i(m),y=n(6),g=i(y),N=n(4),w=i(N),A=n(3),M=i(A),E=function(e){void 0===e&&(e=[]),this.dummyBetaMemory=new u.BetaMemory,this.rootAlpha=new u.AlphaNode,this.actionFunctions=a.default.clone(g),this.Rule=v.Rule,this.ComparisonOperators=w,this.ArithmeticOperators=M,this.ProposedAction=u.ProposedAction,this.WME=u.WME,this.Token=u.Token,this.utils=p,this.allRules={},this.actions={},this.allWMEs={},this.proposedActions={},this.enactedActions=[],this.allReteNodes={},this.allReteNodesByType={},this.currentTime=1,this.schedule={assertions:[],retractions:[],modifications:[]},this.listeners={propose:[],assert:[],retract:[],addRule:[],removeRule:[],schedule:[],stepTimeActions:[],registerAction:[]},e.forEach(function(e){this.registerAction(e)},this)};E.prototype.registerListener=function(e,t){void 0!==this.listeners[e]&&this.listeners[e].push(t)},E.prototype.fireListener=function(e){for(var t=arguments.length,n=Array(t>1?t-1:0),i=1;i<t;i++)n[i-1]=arguments[i];if(void 0===this.listeners[e])throw new Error("Unrecognised listener fired: "+e);this.listeners[e].forEach(function(e){return e.apply(void 0,n)})},E.prototype.storeWME=function(e){this.allWMEs[e.id]=e},E.prototype.clearHistory=function(){this.enactedActions=[]},E.prototype.clearProposedActions=function(){this.proposedActions={}},E.prototype.assertWME=function(e){return this.fireListener("assert",e),e instanceof u.WME||(e=new u.WME(e,this.currentTime),this.storeWME(e)),f.alphaNodeActivation(this.rootAlpha,e),e.id},E.prototype.retractWME=function(e){if(this.fireListener("retract",e),!(e instanceof u.WME))if(Number.isInteger(e)&&void 0!==this.allWMEs[e])e=this.allWMEs[e];else{if(void 0===e.wmeId||void 0===this.allWMEs[e.wmeId])throw console.log("Unknown:",e),new Error("Unknown wme to retract");e=this.allWMEs[e.wmeId]}f.removeAlphaMemoryItemsForWME(e);var t=f.deleteAllTokensForWME(e);return p.cleanupInvalidatedActions(t),f.deleteAllNegJoinResultsForWME(e),e.lifeTime[1]=this.currentTime,delete this.allWMEs[e.id],e},E.prototype.modifyWME=function(e,t){var n=this.retractWME(e),i=n.data,r=t(i);if(void 0===r||null===r)throw new Error("Modify function must return the new data");return this.assertWME(r)},E.prototype.proposeAction=function(e){var t=this;if(this.fireListener("propose",e),e instanceof Array)return void e.forEach(function(e){return t.proposeAction(e)});if(void 0!==this.proposedActions[e.id])throw new Error("Proposing a duplicate action");this.proposedActions[e.id]=e},E.prototype.scheduleAction=function(e){var t=this;if(this.fireListener("schedule",e),e instanceof this.ProposedAction)return void this.scheduleAction(e.id);if(void 0===this.proposedActions[e])throw new Error("Invalid action specified: "+e);var n=this.proposedActions[e],i=n.parallelActions.map(function(e){return t.proposedActions[e]});return this.addToSchedule(n),i.forEach(function(e){return t.addToSchedule(e)}),this},E.prototype.addToSchedule=function(e){if(void 0===e.actionType||void 0===e.payload||void 0===e.timing)throw new Error("Scheduling action failure");void 0===this.schedule[e.actionType]&&(this.schedule[e.actionType]=[]);var t=this.currentTime+e.timing.performOffset;void 0===this.schedule[e.actionType][t]&&(this.schedule[e.actionType][t]=[]),this.schedule[e.actionType][t].push(e),e.token.proposedActions=a.default.reject(e.token.proposedActions,function(t){return t.id===e.id}),delete this.proposedActions[e.id]},E.prototype.stepTime=function(){var e=this,t=a.default.values(this.schedule),n=a.default.reject(a.default.flatten(t.map(function(t){return t[e.currentTime]})),function(e){return void 0===e});n.sort(function(e,t){return t.priority-e.priority}),this.fireListener("stepTimeActions",n);var i=n.map(function(e){var t=this.actionFunctions[e.actionType].perform,n=t(e,this);return this.enactedActions.push(e),n},this);return a.default.values(this.proposedActions).forEach(function(e){e.timing.invalidateTime===this.currentTime&&delete this.proposedActions[e.id]},this),this.currentTime++,i},E.prototype.addRule=function(e,t){var n=this;if(this.fireListener("addRule",t),e instanceof Array)return e.map(function(e){return n.addRule(e,t)});if(e instanceof this.Rule){var i=this.convertRulesToComponents(e);return this.addRule(e.id,i)}if(!Number.isInteger(e)||void 0===t[e])throw new Error("Unrecognised rule id specified");var r=t[e],o=a.default.toPairs(r.linkedNodes),s=o.filter(function(e){return/^condition/.test(e[1])}).map(function(e){return t[e[0]]}),c=d.buildOrShareNetworkForConditions(this.dummyBetaMemory,s,this.rootAlpha,t,this),l=o.filter(function(e){return/^action/.test(e[1])}).map(function(e){return t[e[0]]}),f=l.map(function(e){if(void 0===this.actionFunctions[e.tags.actionType])throw new Error("Unrecognised action type");return a.default.bind(this.actionFunctions[e.tags.actionType].propose,e)},this),h=new u.ActionNode(c,l,f,r.name,this);return h.ruleId=r.id,h.boundActions=f,this.actions[h.ruleId]=h,this.allRules[h.ruleId]=r,[this,h]},E.prototype.removeRule=function(e){var t=this;if(this.fireListener("removeRule",e),e instanceof Array)return void e.forEach(function(e){return t.removeRule(e)});var n=e instanceof u.ActionNode?e:this.actions[e.id],i=f.deleteNodeAndAnyUnusedAncestors(n);p.cleanupInvalidatedActions(i),void 0!==this.allRules[n.ruleId]&&delete this.allRules[n.ruleId],a.default.keys(this.allReteNodes).forEach(function(e){if(this.allReteNodes[e].cleanup===!0){var t=this.allReteNodes[e];delete this.allReteNodesByType[t.type][t.id],delete this.allReteNodes[e]}},this),void 0!==this.actions[e.id]&&delete this.actions[e.id]},E.prototype.registerAction=function(e){if(this.fireListener("registerAction",e),void 0===e.name||void 0===e.perform||void 0===e.propose)throw new Error("Action Registration Failure");if(void 0!==this.actionFunctions[e.name])throw new Error("Registration Attempt for existing Action");this.actionFunctions[e.name]=e},E.prototype.storeNode=function(e){this.allReteNodes[e.id]=e,void 0===this.allReteNodesByType[e.type]&&(this.allReteNodesByType[e.type]={}),this.allReteNodesByType[e.type][e.id]=e},E.prototype.convertRulesToComponents=function(e){e instanceof Array||(e=[e]);var t=a.default.flatten(e.map(function(e){return a.default.values(e.actions)})),n=a.default.flatten(e.map(function(e){return a.default.values(e.conditions)})),i=t.concat(n).concat(e),r=i.reduce(function(e,t){return e[t.id]=t,e},{});return a.default.values(r).forEach(function(e){e.linkedNodes={},e.linkedNodes=a.default.keys(e.actions).reduce(function(e,t){return e[t]="action",e},e.linkedNodes),e.linkedNodes=a.default.keys(e.conditions).reduce(function(e,t){return e[t]="condition",e},e.linkedNodes)}),r},E.prototype.cleanup=function(){var e=this;a.default.values(this.allWMEs).forEach(function(t){return e.retractWME(t)}),this.allWMEs={},this.removeRule(a.default.values(this.allRules))},t.ReteNet=E}])});