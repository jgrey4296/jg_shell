<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: Commands/SimulationCommands.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: Commands/SimulationCommands.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>
define(['underscore'],function(_){
    "use strict";

    /**
     Interface for controlling a simulation
     @exports Commands/SimulationCommands
     @implements module:Commands/CommandTemplate
     */
    var SimulationCommands = {
        /** draw */
        "draw" : function(globalData,values){
            //draw list of characters

            //draw list of performed actions
        },
        /** cleanup */
        "cleanup" : function(globalData,values){

        },
        /** setupSim */
        "setupSim" : function(globalData,values){
            console.log("Setting up simulation");
            //get all the nodes in the institution specified
            var maxTurns = values.shift() || 10,
                sourceId = values.shift() || globalData.shell.cwd.id;
            if(globalData.shell.getNode(sourceId).tags.type !== 'institution'){
                throw new Error("Simulation requires an institution");
            }

            //Get all the children of the specified institution
            var institutionIds = globalData.shell.dfs(sourceId,['children']),
                characters = _.values(globalData.shell.allNodes).filter(function(d){
                    return d.tags.character !== undefined;
                });
            console.log("InstitutionIds:",institutionIds);
            console.log("Characters:",characters);
            
            globalData.simulation = {};
            globalData.simulation.reteNet = globalData.shell.reteNet;
            globalData.simulation.characterPool = characters;
            globalData.simulation.usedCharacterPool = [];
            globalData.simulation.turn = 0;
            globalData.simulation.maxTurns = maxTurns;
            
            //compile the reteNet using the rules in the institution
            globalData.shell.compileRete(institutionIds);
            //assert starting facts
            //todo: possible initialise the institution from options here
            
            globalData.shell.assertWMEList(characters);
            globalData.shell.assertWMEs(institutionIds);

        },
        /** stepSim : returns true when finished, false otherwise */
        "stepSim" : function(globalData,values){
            if(globalData.simulation === undefined){
                throw new Error("Simulation must be setup first, run 'setupSim' on an institution");
            }
            if(globalData.simulation.turn >= globalData.simulation.maxTurns) { return true; }
            console.log("Running sim turn: ",globalData.shell.reteNet.currentTime);
            //reset the character pool if empty
            if(globalData.simulation.characterPool.length === 0){
                globalData.simulation.characterPool = globalData.simulation.usedCharacterPool;
                globalData.simulation.usedCharacterPool = [];
            }            
            //select a character to act, remove from pool of characters
            //todo: let user specify an id of a character to act
            var charToUse = _.sample(globalData.simulation.characterPool),
                //Get actions for that character
                actionsForChar = _.filter(globalData.simulation.reteNet.proposedActions,
                                          function(d){
                                              try{
                                                  //TODO: FIX THIS
                                                  return d.payload.tags.character === charToUse.id;
                                              }catch(e){
                                                  return false;
                                              }
                                          }),
                //select a performance... based on something?
                //based on lookup of values of aggregates?
                //!!!! - base on normative level???
                actionToPerform = _.sample(actionsForChar),
                //Get the linked actions (assertions/retractions) for that performance
                linkedActions = actionToPerform !== undefined ? actionToPerform.parallelActions.map(function(d){
                    return globalData.simulation.reteNet.proposedActions[d.id];
                }) : [];
            console.log("CharToUse:",[charToUse,actionsForChar,actionToPerform]);
            
            //return early if theres no available actions
            if(actionToPerform === undefined) { return false; }
            //todo: perform the action
            //convert performance description to actual


            
            //add actual performance to list of performances, which will be drawn in draw
            
            
            //todo:assert facts, retract facts based on the action, which may remove the action from potentials.
            
            //increment time
            globalData.shell.stepTime();
            globalData.simulation.turn++;
            //-----
            //finish and summarise

            return false;
        },
        /** Depth First Search */
        "dfs" : function(globalData,values){
            if(values.length === 0) { values = [globalData.shell.cwd.id]; }
            console.log(globalData.shell.dfs(values[0]));
        },
        /** Help */
        "help" : function(globalData,values){
            return {
                "setupSim" : ["$sourceId?","Initialise the retenet for simulation"],
                "stepSim" : ["", "Run a step of the simulation"],
            };
        },
    };

    return SimulationCommands;
});
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Modules</h3><ul><li><a href="module-Browser_WebMain.html">Browser/WebMain</a></li><li><a href="module-CLI_HelpCLI.html">CLI/HelpCLI</a></li><li><a href="module-CLI_MainCommandCLI.html">CLI/MainCommandCLI</a></li><li><a href="module-Commands_BookMarkCommands.html">Commands/BookMarkCommands</a></li><li><a href="module-Commands_Command_Aggregate.html">Commands/Command_Aggregate</a></li><li><a href="module-Commands_CommandTemplate.html">Commands/CommandTemplate</a></li><li><a href="module-Commands_GeneralCommands.html">Commands/GeneralCommands</a></li><li><a href="module-Commands_NodeCommands.html">Commands/NodeCommands</a></li><li><a href="module-Commands_ReteCommands.html">Commands/ReteCommands</a></li><li><a href="module-Commands_RuleCommands.html">Commands/RuleCommands</a></li><li><a href="module-Commands_SimulationCommands.html">Commands/SimulationCommands</a></li><li><a href="module-Commands_TraceCommands.html">Commands/TraceCommands</a></li><li><a href="module-Drawing_DrawUtils.html">Drawing/DrawUtils</a></li><li><a href="module-Drawing_GeneralDrawing.html">Drawing/GeneralDrawing</a></li><li><a href="module-Drawing_NodeDrawing.html">Drawing/NodeDrawing</a></li><li><a href="module-Drawing_RuleDrawing.html">Drawing/RuleDrawing</a></li><li><a href="module-Drawing_TraceDrawing.html">Drawing/TraceDrawing</a></li><li><a href="module-Node_Action.html">Node/Action</a></li><li><a href="module-Node_Bookmark.html">Node/Bookmark</a></li><li><a href="module-Node_Condition.html">Node/Condition</a></li><li><a href="module-Node_Constructors.html">Node/Constructors</a></li><li><a href="module-Node_GraphNode.html">Node/GraphNode</a></li><li><a href="module-Node_Institution.html">Node/Institution</a></li><li><a href="module-Node_Rule.html">Node/Rule</a></li><li><a href="module-Parse.html">Parse</a></li><li><a href="module-Shell.html">Shell</a></li><li><a href="module-ShellModule_shell_node_mod.html">ShellModule/shell_node_mod</a></li><li><a href="module-ShellModules_shell_graph_search.html">ShellModules/shell_graph_search</a></li><li><a href="module-ShellModules_shell_json.html">ShellModules/shell_json</a></li><li><a href="module-ShellModules_shell_node_addition.html">ShellModules/shell_node_addition</a></li><li><a href="module-ShellModules_shell_node_deletion.html">ShellModules/shell_node_deletion</a></li><li><a href="module-ShellModules_shell_prototype_extraction.html">ShellModules/shell_prototype_extraction</a></li><li><a href="module-ShellModules_shell_prototype_main.html">ShellModules/shell_prototype_main</a></li><li><a href="module-ShellModules_shell_rete.html">ShellModules/shell_rete</a></li><li><a href="module-ShellModules_shell_search.html">ShellModules/shell_search</a></li><li><a href="module-ShellModules_shell_state_change.html">ShellModules/shell_state_change</a></li><li><a href="module-ShellModules_shell_string.html">ShellModules/shell_string</a></li><li><a href="module-utils.html">utils</a></li></ul><h3>Classes</h3><ul><li><a href="module-Node_Rule.html">Node/Rule</a></li><li><a href="module-Shell.html">Shell</a></li><li><a href="Node_Action.html">Node/Action</a></li><li><a href="Node_Bookmark.html">Node/Bookmark</a></li><li><a href="Node_Condition.html">Node/Condition</a></li><li><a href="Node_GraphNode.html">Node/GraphNode</a></li><li><a href="Node_Institution.html">Node/Institution</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.4.0</a> on Sun Feb 28 2016 05:31:58 GMT-0800 (PST)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
