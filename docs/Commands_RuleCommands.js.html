<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: Commands/RuleCommands.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: Commands/RuleCommands.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>
define(['d3','utils','underscore','Drawing/RuleDrawing','Drawing/NodeDrawing'],function(d3,util,_,RuleDrawing,NodeDrawing){
    "use strict";

    /**
     To implement all user commands dealing with rules
     @exports Commands/RuleCommands
     @implements module:Commands/CommandTemplate
     */
    var ruleCommands = {
        /** draw 
            @param globalData
            @param values
        */
        "draw" : function(globalData,values){
            if(globalData.shell.cwd.tags.type.toLowerCase() === "rule"){
                RuleDrawing.drawRule(globalData,globalData.shell.cwd);
                //drawRule(globalData);
            }else if(globalData.shell.cwd.tags.type === "negConjCondition"){
                //TODO: draw neg conj condition
                RuleDrawing.drawRule(globalData,globalData.shell.cwd);
                //drawRule(globalData);
            }else{
                //ruleCommands.cleanup();
                //NodeDrawing.drawNode(globalData,globalData.shell.cwd);
            }
        },
        /** cleanup 
            @param globalData
            @param values
        */
        "cleanup" : function(globalData, values){
            RuleDrawing.cleanup();
        },
        /** cd 
            @param globalData
            @param values
        */
        "cd" : function(globalData,values){
            //switch back to node mode
            var modes = _.keys(globalData.commands);
            if(modes.indexOf('node') !== -1){
                globalData.commands[globalData.currentCommandMode].cleanup(globalData,[]);
                globalData.currentCommandMode = modes[modes.indexOf('node')];
                //execute cd
                var cd = globalData.lookupOrFallBack('cd',globalData);
                cd(globalData,values);
            }
        },
        /** new -> addCondition/test/action 
            @param globalData
            @param values
        */
        "new" : function(globalData,values,sourceId){
            var type = values.shift();
            if(type === "condition"){
                if(values.length > 0 &amp;&amp; !isNaN(Number(values[0]))){
                    sourceId = Number(values.shift());
                }
                globalData.shell.addNode(null,'conditions','condition',values,sourceId);
            }else if(type === "action"){
                globalData.shell.addAction(values,sourceId);
            }else if(type === "negCondition"){
                globalData.shell.addNode(null,'conditions','negCondition',values,sourceId);
            }else if(type === "negConjCondition"){
                globalData.shell.addNode(null,'conditions','negConjCondition',values,sourceId);
            }
        },
        /** if - a short way to define conditions 
            @param globalData
            @param values
        */
        "if" : function(globalData, values,sourceId){
            values = values.map(function(d){
                return d.replace(/,/,"");
            });
            var newCondition = globalData.shell.addNode(null,'conditions','condition',values,sourceId);
            while(values.length >= 3){
                var currentTest = values.splice(0,3);
                globalData.shell.addTest(newCondition.id,currentTest);
            }            
        },
        /** rm 
            @param globalData
            @param values
        */
        "rm" : function(globalData,values,sourceId){
            //remove action
            if(values[0] === 'action'){
                globalData.shell.removeAction(values.slice(1),sourceId);
            }
            //condition
            if(values[0] === 'condition'){
                globalData.shell.removeCondition(values.slice(1),sourceId);
            }                
        },
        /** set 
            @param globalData
            @param values
        */
        "set" : function(globalData,values,sourceId){
            //set action 0 type assert
            //set condiiton 4 test a EQ 5
            //set condition 4 test 5 a GT 10
            //set condition 5 binding a b
            //set action 0 value a #b
            //set action 0 arith a + 2
            //set rule 3 values a 5
            var targetType = values.shift(),
                targetId = values.shift(),
                targetField = values.shift();
            //console.log("SET:",targetType,targetId,targetField);

            if(Number.isNaN(Number(targetId)) || globalData.shell.allNodes[Number(targetId)] === undefined){
                throw new Error("Unrecognised targetId");
            }
            
            //Set elements of an action:
            if(targetType === 'action' &amp;&amp; targetField === 'type'){
                globalData.shell.setActionType(Number(targetId),values[0],sourceId);
            }

            if(targetType === 'action' &amp;&amp; targetField === 'data'){
                globalData.shell.setActionValue(Number(targetId),values[0],values[1],sourceId);
            }
            
            if(targetType === 'action' &amp;&amp; targetField === 'arith'){
                globalData.shell.setArithmetic(Number(targetId),values[0],values[1],values[2],sourceId);
            }

            if(targetType === 'action' &amp;&amp; targetField === 'regex'){
                globalData.shell.setRegex(Number(targetId),values[0],values[1],sourceId);
            }

            if(targetType === 'action' &amp;&amp; targetField === 'timing'){
                globalData.shell.setTiming(Number(targetId),values[0],values[1],sourceId);
            }
            
            //todo: set action tags
            
            //Set binding of a condition:
            //ie: set condition n binding a b
            //desired: set condition n binding a b (NE otherBinding, GT otherBinding2...)
            if(targetType === 'condition' &amp;&amp; targetField === 'binding'){
                if(values.length >= 2){
                    var boundName = values.shift(),
                        dataName = values.shift(),
                        bindingTests = [];
                    while(values.length > 0){
                        var a = values.shift(),
                            b = values.shift();
                        bindingTests.push([a,b]);                        
                    }
                    
                    globalData.shell.setBinding(Number(targetId),boundName,dataName,bindingTests,sourceId);
                }else if(values.length === 1){
                    globalData.shell.removeBinding(Number(targetId),values[0],sourceId);
                }
            }

            //create or set a test
            if(targetType === 'condition' &amp;&amp; targetField === 'test'){
                //if test is specified and exists:
                if(values.length === 4){
                    globalData.shell.setTest(Number(targetId),Number(values[0]),values[1],values[2],values[3],sourceId);
                    //otherwise if creating a new test:
                }else if(values.length === 3){
                    globalData.shell.addTest(Number(targetId),values,sourceId);
                }else if(values.length === 1){
                    globalData.shell.removeTest(Number(targetId),Number(values[0]),sourceId);
                }
            }
        },
        /** rename 
            @param globalData
            @param values
        */
        "rename" : function(globalData,values){
            globalData.shell.rename(values[0]);
        },
        /** infer 
            @param globalData
            @param values
        */
        "infer" : function(globalData,values){
            globalData.shell.extractFactPrototypes();
        },
        /** link 
            @param globalData
            @param values
        */
        "link" : function(globalData,values){
            //currently not used, but the syntax is more pleasing if included
            var targetType = values.shift(),
            //get the condition/action being targeted
                condOrAction = globalData.shell.getNode(values.shift()),
            //get the node being linked
                nodeToLink = globalData.shell.getNode(values.shift());

            if(condOrAction === undefined || condOrAction.expectationNode === undefined){
                throw new Error("Linking needs a valid node to hold expectation");
            }
            if(nodeToLink === undefined){
                throw new Error("Linking needs a valid node to expect");
            }
            //if you are overwriting an expectation:
            //remove the old expectation
            if(condOrAction.expectationNode !== null){
                var oldExpectation = globalData.shell.getNode(condOrAction.expectationNode);
                if(oldExpectation &amp;&amp; condOrAction.tags.type === "condition"){
                    delete oldExpectation.expectedBy[condOrAction.id];
                }else if(oldExpectation &amp;&amp; condOrAction.tags.type === "action"){
                    delete oldExpectation.producedBy[condOrAction.id];
                }
            }
            //assign it to the expectation node
            condOrAction.expectationNode = nodeToLink.id;
            //store the expectation in the node
            if(condOrAction.tags.type === "condition"){
                nodeToLink.expectedBy[condOrAction.id] = condOrAction.name;
            }else if(condOrAction.tags.type === "action"){
                nodeToLink.producedBy[condOrAction.id] = condOrAction.name;
            }
            
        },
        /** help 
            @param globalData
            @param values
        */
        "help" : function(globalData,values){
            return {
                "help#general" : [ "", "Display General Commands Help"],
                "cd"    : [ "[.. | $name | $id]", "Move to other nodes. Reverts to node mode"],
                "new condition" : [ " ", " Create a new condition for the current rule. (IF)"],
                "new negCondtion" : ["", "Create a negative condition"],
                "new negConjCondition" : ["","Create a Negated Conjunctive Condition"],
                "new action" : [ "$name+", " Create a new action for the current rule. (THEN)"],
                "rm"     : [ "[condition | action] $id", " Remove a condition/action/test"],
                "set" : ["$targetType $targetId $targetFocus $values", "ie: set condition 5 binding a b"],
                "rename" : ["", " Rename the rule"],
                "link"   : ["$target $conditionOrActionId $nodeId", "Link a condition or action with the node in the graph it tests or produces"],
                "set action" : ["$id regex $varname $regex $options $replaceVal", ""],
                //todo: explain setting action data/arith/regex
            };
        },
    };

    //--------------------
    return ruleCommands;

});
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Modules</h3><ul><li><a href="module-Browser_WebMain.html">Browser/WebMain</a></li><li><a href="module-CLI_HelpCLI.html">CLI/HelpCLI</a></li><li><a href="module-CLI_MainCommandCLI.html">CLI/MainCommandCLI</a></li><li><a href="module-Commands_BookMarkCommands.html">Commands/BookMarkCommands</a></li><li><a href="module-Commands_Command_Aggregate.html">Commands/Command_Aggregate</a></li><li><a href="module-Commands_CommandTemplate.html">Commands/CommandTemplate</a></li><li><a href="module-Commands_GeneralCommands.html">Commands/GeneralCommands</a></li><li><a href="module-Commands_NodeCommands.html">Commands/NodeCommands</a></li><li><a href="module-Commands_ReteCommands.html">Commands/ReteCommands</a></li><li><a href="module-Commands_RuleCommands.html">Commands/RuleCommands</a></li><li><a href="module-Commands_SimulationCommands.html">Commands/SimulationCommands</a></li><li><a href="module-Commands_TraceCommands.html">Commands/TraceCommands</a></li><li><a href="module-Drawing_DrawUtils.html">Drawing/DrawUtils</a></li><li><a href="module-Drawing_GeneralDrawing.html">Drawing/GeneralDrawing</a></li><li><a href="module-Drawing_NodeDrawing.html">Drawing/NodeDrawing</a></li><li><a href="module-Drawing_RuleDrawing.html">Drawing/RuleDrawing</a></li><li><a href="module-Drawing_TraceDrawing.html">Drawing/TraceDrawing</a></li><li><a href="module-globalData.html">globalData</a></li><li><a href="module-Node_Action.html">Node/Action</a></li><li><a href="module-Node_Bookmark.html">Node/Bookmark</a></li><li><a href="module-Node_Condition.html">Node/Condition</a></li><li><a href="module-Node_Constructors.html">Node/Constructors</a></li><li><a href="module-Node_GraphNode.html">Node/GraphNode</a></li><li><a href="module-Node_Institution.html">Node/Institution</a></li><li><a href="module-Node_Rule.html">Node/Rule</a></li><li><a href="module-Parse.html">Parse</a></li><li><a href="module-Shell.html">Shell</a></li><li><a href="module-ShellModules_shell_graph_search.html">ShellModules/shell_graph_search</a></li><li><a href="module-ShellModules_shell_json.html">ShellModules/shell_json</a></li><li><a href="module-ShellModules_shell_node_addition.html">ShellModules/shell_node_addition</a></li><li><a href="module-ShellModules_shell_node_deletion.html">ShellModules/shell_node_deletion</a></li><li><a href="module-ShellModules_shell_node_mod.html">ShellModules/shell_node_mod</a></li><li><a href="module-ShellModules_shell_prototype_extraction.html">ShellModules/shell_prototype_extraction</a></li><li><a href="module-ShellModules_shell_prototype_main.html">ShellModules/shell_prototype_main</a></li><li><a href="module-ShellModules_shell_rete.html">ShellModules/shell_rete</a></li><li><a href="module-ShellModules_shell_search.html">ShellModules/shell_search</a></li><li><a href="module-ShellModules_shell_state_change.html">ShellModules/shell_state_change</a></li><li><a href="module-ShellModules_shell_string.html">ShellModules/shell_string</a></li><li><a href="module-utils.html">utils</a></li></ul><h3>Classes</h3><ul><li><a href="GraphNode.html">GraphNode</a></li><li><a href="module-Node_Action-Action.html">Action</a></li><li><a href="Node_Bookmark.html">Node/Bookmark</a></li><li><a href="Node_Condition.html">Node/Condition</a></li><li><a href="Node_Institution.html">Node/Institution</a></li><li><a href="Node_Rule.html">Node/Rule</a></li><li><a href="Shell.html">Shell</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.4.0</a> on Mon Feb 29 2016 03:17:40 GMT-0800 (PST)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
